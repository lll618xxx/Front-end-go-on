<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1.axios原理 | 首页</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/Front-end-go-on/logo.png">
    <meta name="description" content="前端记录">
    
    <link rel="preload" href="/Front-end-go-on/assets/css/0.styles.b60766ec.css" as="style"><link rel="preload" href="/Front-end-go-on/assets/js/app.9707f389.js" as="script"><link rel="preload" href="/Front-end-go-on/assets/js/2.df6f2bda.js" as="script"><link rel="preload" href="/Front-end-go-on/assets/js/1.c1a4e5b8.js" as="script"><link rel="preload" href="/Front-end-go-on/assets/js/19.25243b30.js" as="script"><link rel="prefetch" href="/Front-end-go-on/assets/js/10.c33fa5a6.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/11.b4e31df2.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/12.98ab490b.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/13.1c3423bc.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/14.4dc47ee1.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/15.d671e7a1.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/16.20003df4.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/17.cb996539.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/18.8d35516e.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/20.7d855641.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/21.f669ad42.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/22.f8bd497d.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/23.b12ca935.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/24.039560e6.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/25.d60682a2.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/26.5475348e.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/27.224adbc5.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/28.fd7e4ae7.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/29.b5459626.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/3.9313d513.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/30.c75ac263.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/31.34eba0cc.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/32.6afcda0a.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/33.eed7a6e2.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/34.cea152da.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/35.5f047340.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/36.06f41917.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/37.7e66bdf8.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/38.0d811e82.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/39.354fc377.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/4.cfb78dd9.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/40.e93f125d.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/41.837e4760.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/42.9725c8f7.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/43.c4756df2.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/44.6ebd9bc5.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/45.cc904ba0.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/46.52647cd7.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/47.681aef6a.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/48.73d607ff.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/49.bb0cf1a1.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/5.b689cad7.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/50.8b7273ef.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/51.a03297ce.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/52.3770162e.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/53.07eed27d.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/54.ca14ae08.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/55.83382fcc.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/56.11125a01.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/57.2705d3df.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/58.d4b40231.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/59.220e3259.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/6.83fd7a3c.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/60.3a889264.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/61.f0c622dd.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/62.d626fddb.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/63.1b7bb160.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/64.d57fa5b0.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/65.bf17a9a7.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/66.211b964a.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/67.6c8063e9.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/68.dd6fd021.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/69.9c2d96a7.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/7.b1e8ce5a.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/70.d3f4c9ce.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/71.89015342.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/72.50e53e59.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/73.e3ee4239.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/74.c7dbabd3.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/75.1042ba60.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/76.0e3fde05.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/77.20724f2e.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/78.c77ad605.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/79.c00cd408.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/80.f3a6decd.js"><link rel="prefetch" href="/Front-end-go-on/assets/js/vendors~docsearch.aa845c0e.js">
    <link rel="stylesheet" href="/Front-end-go-on/assets/css/0.styles.b60766ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Front-end-go-on/" class="home-link router-link-active"><img src="/Front-end-go-on/logo.png" alt="首页" class="logo"> <span class="site-name can-hide">首页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Front-end-go-on/pages/frontend/base/Html.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/Front-end-go-on/pages/otherLang/node/base.html" class="nav-link">
  非前端
</a></div><div class="nav-item"><a href="/Front-end-go-on/pages/assit/chrome/Extension.html" class="nav-link">
  辅助
</a></div><div class="nav-item"><a href="https://github.com/lll618xxx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Front-end-go-on/pages/frontend/base/Html.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/Front-end-go-on/pages/otherLang/node/base.html" class="nav-link">
  非前端
</a></div><div class="nav-item"><a href="/Front-end-go-on/pages/assit/chrome/Extension.html" class="nav-link">
  辅助
</a></div><div class="nav-item"><a href="https://github.com/lll618xxx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front-end-go-on/pages/frontend/base/Html.html" class="sidebar-link">HTML基础</a></li><li><a href="/Front-end-go-on/pages/frontend/base/Css.html" class="sidebar-link">CSS基础</a></li><li><a href="/Front-end-go-on/pages/frontend/base/Js.html" class="sidebar-link">JS基础</a></li><li><a href="/Front-end-go-on/pages/frontend/base/ES6.html" class="sidebar-link">ES6基础</a></li><li><a href="/Front-end-go-on/pages/frontend/base/Http.html" class="sidebar-link">HTTP基础</a></li><li><a href="/Front-end-go-on/pages/frontend/base/Cache.html" class="sidebar-link">前端缓存</a></li><li><a href="/Front-end-go-on/pages/frontend/base/Performance.html" class="sidebar-link">页面性能</a></li><li><a href="/Front-end-go-on/pages/frontend/base/Algorithm.html" class="sidebar-link">数据结构基础</a></li><li><a href="/Front-end-go-on/pages/frontend/base/MyArticle.html" class="sidebar-link">我的文章</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front-end-go-on/pages/frontend/frame/base/Vue.html" class="sidebar-link">Vue2基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/advanced/Vue.html" class="sidebar-link">Vue2进阶</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/Vue3.html" class="sidebar-link">Vue3基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/advanced/Vue3.html" class="sidebar-link">Vue3进阶</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/React.html" class="sidebar-link">React基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/advanced/React.html" class="sidebar-link">React进阶</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/advanced/React18.html" class="sidebar-link">React18新特性</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/VueVsReact.html" class="sidebar-link">Vue和React对比</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/RN.html" class="sidebar-link">RN基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/RNEnv.html" class="sidebar-link">RN环境搭建和打包</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/Packaging.html" class="sidebar-link">打包工具</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/Ts.html" class="sidebar-link">TS基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/Nuxt.html" class="sidebar-link">Nuxt基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/Applet.html" class="sidebar-link">小程序基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/MicroFrontend.html" class="sidebar-link">微前端基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/UniApp.html" class="sidebar-link">uni-app基础</a></li><li><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html" aria-current="page" class="active sidebar-link">业务相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html#_1-axios原理" class="sidebar-link">1.axios原理</a></li><li class="sidebar-sub-header"><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html#_2-i18n原理" class="sidebar-link">2.i18n原理</a></li><li class="sidebar-sub-header"><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html#_3-移动端常见问题" class="sidebar-link">3.移动端常见问题</a></li><li class="sidebar-sub-header"><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html#_4-h5和app的webview交互" class="sidebar-link">4.H5和App的Webview交互</a></li><li class="sidebar-sub-header"><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html#_5-h5唤起app" class="sidebar-link">5.H5唤起APP</a></li><li class="sidebar-sub-header"><a href="/Front-end-go-on/pages/frontend/frame/base/Business.html#_6-web-workers-解决主线程阻塞问题" class="sidebar-link">6.Web Workers 解决主线程阻塞问题</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端代码练习</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front-end-go-on/pages/frontend/exercise/Css.html" class="sidebar-link">CSS代码练习</a></li><li><a href="/Front-end-go-on/pages/frontend/exercise/Js.html" class="sidebar-link">JS代码练习</a></li><li><a href="/Front-end-go-on/pages/frontend/exercise/Algorithm.html" class="sidebar-link">算法代码练习</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端代码技巧</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front-end-go-on/pages/frontend/skill/Tools.html" class="sidebar-link">工具库</a></li><li><a href="/Front-end-go-on/pages/frontend/skill/Utils.html" class="sidebar-link">工具函数</a></li><li><a href="/Front-end-go-on/pages/frontend/skill/CSSAnimation.html" class="sidebar-link">CSS动画库</a></li><li><a href="/Front-end-go-on/pages/frontend/skill/Css.html" class="sidebar-link">CSS代码技巧</a></li><li><a href="/Front-end-go-on/pages/frontend/skill/Js.html" class="sidebar-link">JS代码技巧</a></li><li><a href="/Front-end-go-on/pages/frontend/skill/Project.html" class="sidebar-link">项目技巧</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-axios原理"><a href="#_1-axios原理" class="header-anchor">#</a> 1.axios原理</h2> <p>Axios 是一个基于 Promise 的 HTTP 客户端，用于浏览器和 Node.js 环境。</p> <ul><li>浏览器环境：使用 XMLHttpRequest（XHR）</li> <li>Node.js 环境：使用 http/https 模块</li></ul> <p><strong>与 Fetch API 的对比</strong></p> <table><thead><tr><th>特性</th> <th>Axios</th> <th>Fetch API</th></tr></thead> <tbody><tr><td>​本质​</td> <td>第三方库（需要安装）</td> <td>浏览器原生 API</td></tr> <tr><td>浏览器支持​</td> <td>广泛（通过 XHR 回退）</td> <td>现代浏览器</td></tr> <tr><td>​​请求取消​</td> <td>支持完善</td> <td>通过 AbortController 支持</td></tr> <tr><td>拦截器​</td> <td>内置请求/响应拦截器</td> <td>需要自行实现</td></tr> <tr><td>Node.js支持​</td> <td>支持</td> <td>不支持（需使用node-fetch等polyfill）</td></tr> <tr><td>进度监控​</td> <td>支持</td> <td>不支持</td></tr> <tr><td>​​超时控制​</td> <td>内置</td> <td>需要自行实现</td></tr> <tr><td>​​CSRF防护​</td> <td>内置（XSRF-TOKEN）</td> <td>需要自行实现</td></tr> <tr><td>数据转换​</td> <td>自动</td> <td>需要手动处理</td></tr></tbody></table> <h3 id="一、整体架构设计"><a href="#一、整体架构设计" class="header-anchor">#</a> 一、整体架构设计</h3> <p>Axios 采用了分层架构设计，主要分为以下几层：</p> <ul><li><ol><li>​核心层（Core）​​：提供基础请求能力</li></ol></li> <li><ol start="2"><li>​适配器层（Adapter）​​：处理环境差异（浏览器/XHR 和 Node.js/http）</li></ol></li> <li><ol start="3"><li>​拦截器层（Interceptors）​​：请求/响应拦截机制</li></ol></li> <li><ol start="4"><li>配置层（Config）​​：统一的配置管理</li></ol></li> <li><ol start="5"><li>取消请求层（Cancel）​​：请求取消功能</li></ol></li></ul> <h3 id="二、核心实现原理"><a href="#二、核心实现原理" class="header-anchor">#</a> 二、核心实现原理</h3> <h4 id="_1-请求发送流程"><a href="#_1-请求发送流程" class="header-anchor">#</a> 1. 请求发送流程</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 简化版请求流程</span>
<span class="token keyword">function</span> <span class="token function">Axios</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 合并配置</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>defaults <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span>defaults<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 初始化拦截器</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">request</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">response</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Axios</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">request</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 参数处理（支持 axios('url', config) 形式）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> config <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>url <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2. 合并配置</span>
  config <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 转换请求数据</span>
  config<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">(</span>
    config<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>transformRequest
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4. 构建请求链</span>
  <span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>dispatchRequest<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 5. 添加请求拦截器（后添加的先执行）</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    chain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 6. 添加响应拦截器（先添加的先执行）</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    chain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 7. 执行链</span>
  <span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h4 id="_2-适配器实现原理"><a href="#_2-适配器实现原理" class="header-anchor">#</a> 2. 适配器实现原理</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 适配器选择逻辑</span>
<span class="token keyword">function</span> <span class="token function">getDefaultAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> XMLHttpRequest <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 浏览器环境使用 XHR 适配器</span>
    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./adapters/xhr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> process <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Node.js 环境使用 http 适配器</span>
    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./adapters/http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 浏览器 XHR 适配器核心实现</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">xhrAdapter</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化请求</span>
    request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>
      config<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">buildURL</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>url<span class="token punctuation">,</span> config<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置超时</span>
    request<span class="token punctuation">.</span>timeout <span class="token operator">=</span> config<span class="token punctuation">.</span>timeout<span class="token punctuation">;</span>
    <span class="token comment">// 设置响应类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>responseType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span>responseType <span class="token operator">=</span> config<span class="token punctuation">.</span>responseType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置请求头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> config<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理取消</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理请求数据</span>
    <span class="token keyword">let</span> requestData <span class="token operator">=</span> config<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestData <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isStream</span><span class="token punctuation">(</span>requestData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestData <span class="token operator">=</span> <span class="token function">transformRequestData</span><span class="token punctuation">(</span>requestData<span class="token punctuation">,</span> config<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 请求完成处理</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request <span class="token operator">||</span> request<span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token function">transformResponseData</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>response<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">status</span><span class="token operator">:</span> request<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
        <span class="token literal-property property">statusText</span><span class="token operator">:</span> request<span class="token punctuation">.</span>statusText<span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token function">parseHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">config</span><span class="token operator">:</span> config<span class="token punctuation">,</span>
        <span class="token literal-property property">request</span><span class="token operator">:</span> request
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token function">settle</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      request <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 错误处理</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token string">'Network Error'</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      request <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 超时处理</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">ontimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timeout of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms exceeded</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      request <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送请求</span>
    request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>requestData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h3 id="三、关键特性实现原理"><a href="#三、关键特性实现原理" class="header-anchor">#</a> 三、关键特性实现原理</h3> <h4 id="_1-拦截器机制"><a href="#_1-拦截器机制" class="header-anchor">#</a> 1. 拦截器机制</h4> <p>拦截器采用链式 Promise 实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">InterceptorManager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fulfilled<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fulfilled<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">InterceptorManager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 请求链构建逻辑</span>
<span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>dispatchRequest<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  chain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  chain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_2-取消请求实现"><a href="#_2-取消请求实现" class="header-anchor">#</a> 2. 取消请求实现</h4> <p>AbortController 实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 适配 AbortController</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span>signal<span class="token punctuation">.</span>aborted <span class="token operator">||</span> config<span class="token punctuation">.</span>signal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cancel</span><span class="token punctuation">(</span><span class="token string">'canceled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_3-数据转换机制"><a href="#_3-数据转换机制" class="header-anchor">#</a> 3. 数据转换机制</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 默认转换函数</span>
<span class="token literal-property property">transformRequest</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> headers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 Content-Type</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFormData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isArrayBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isStream</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayBufferView</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> data<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isURLSearchParams</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setContentType</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setContentType</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token literal-property property">transformResponse</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="四、性能优化设计"><a href="#四、性能优化设计" class="header-anchor">#</a> 四、性能优化设计</h3> <ul><li><ol><li>​配置合并优化​​：采用深度合并策略</li></ol></li> <li><ol start="2"><li>​​请求数据转换优化​​：按需转换</li></ol></li> <li><ol start="3"><li>适配器懒加载​​：运行时按需加载</li></ol></li> <li><ol start="4"><li>​​内存管理​​：及时清理引用</li></ol></li></ul> <h2 id="_2-i18n原理"><a href="#_2-i18n原理" class="header-anchor">#</a> 2.i18n原理</h2> <h3 id="一、核心概念"><a href="#一、核心概念" class="header-anchor">#</a> 一、核心概念</h3> <ul><li>​国际化(i18n)​​：使应用支持多语言的过程（i和n之间有18个字母）</li> <li>​​本地化(l10n)​​：为特定地区适配内容的过程（l和n之间有10个字母）</li> <li>语言环境(Locale)​​：由语言代码和国家代码组成（如zh-CN, en-US）</li> <li>​​翻译键(Translation Key)​​：用于标识文本片段的唯一键</li> <li>​复数形式(Pluralization)​​：不同语言有不同的复数规则</li> <li>​​文本方向(Text Direction)​​：LTR（左到右）和RTL（右到左）布局</li></ul> <h3 id="二、常见问题与解决方案"><a href="#二、常见问题与解决方案" class="header-anchor">#</a> 二、常见问题与解决方案</h3> <h4 id="_1-翻译管理问题"><a href="#_1-翻译管理问题" class="header-anchor">#</a> 1. 翻译管理问题</h4> <p>现象​​：不同开发者使用不同命名风格，如<code>home.title</code>、<code>homeHeader</code>、<code>home_title</code></p> <ul><li>制定命名规范文档，例如：
<ul><li>模块化命名：模块.功能.元素（<code>login.form.submitButton</code>）</li> <li>统一分隔符：强制使用点号.或下划线_</li></ul></li></ul> <p>使用TS类型约束：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">I18nKeys</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  login<span class="token operator">:</span> <span class="token punctuation">{</span>
    form<span class="token operator">:</span> <span class="token punctuation">{</span>
      submitButton<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'i18next'</span> <span class="token punctuation">{</span>
  <span class="token keyword">interface</span> <span class="token class-name">CustomTypeOptions</span> <span class="token punctuation">{</span>
    resources<span class="token operator">:</span> I18nKeys<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_3-移动端常见问题"><a href="#_3-移动端常见问题" class="header-anchor">#</a> 3.移动端常见问题</h2> <h3 id="一、移动端1px边框问题"><a href="#一、移动端1px边框问题" class="header-anchor">#</a> 一、移动端1px边框问题</h3> <p><a href="https://www.jianshu.com/p/fa670b737a29" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>移动端CSS里面写了1px，实际上看起来比1px粗；<br>
UI设计师要求的1px是指设备的<strong>物理像素</strong>，而CSS里记录的像素是<strong>逻辑像素</strong>。<br>
它们之间存在一个比例关系，可以用javascript中的<code>window.devicePixelRatio</code>来获取，也可以用媒体查询的<code>-webkit-min-device-pixel-ratio</code>来获取。</p> <p>在手机上border无法达到我们想要的效果。这是因为<code>devicePixelRatio</code>特性导致，iPhone的devicePixelRatio==2，而border-width: 1px描述的是设备独立像素。<br>
所以，border被放大到物理像素2px显示，在iPhone上就显得较粗。</p> <ul><li>​设备像素比（DPR）​​：
<ul><li>普通屏幕：DPR = 1（1个CSS像素 = 1个物理像素）</li> <li>Retina屏幕：DPR = 2或3（1个CSS像素 = 2或3个物理像素）</li></ul></li></ul> <ul><li>解决方案：</li></ul> <h4 id="_1、媒体查询-transfrom-对第一个方案的优化"><a href="#_1、媒体查询-transfrom-对第一个方案的优化" class="header-anchor">#</a> 1、媒体查询 + transfrom，对第一个方案的优化</h4> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/* 2倍屏 */</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token keyword">only</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">-webkit-min-device-pixel-ratio</span><span class="token punctuation">:</span> 2.0<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
    <span class="token selector">.border-bottom::after</span> <span class="token punctuation">{</span>
        <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 3倍屏 */</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token keyword">only</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">-webkit-min-device-pixel-ratio</span><span class="token punctuation">:</span> 3.0<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
    <span class="token selector">.border-bottom::after</span> <span class="token punctuation">{</span>
        <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>0.33<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>0.33<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_2、使用-svg-矢量图"><a href="#_2、使用-svg-矢量图" class="header-anchor">#</a> 2、使用 SVG 矢量图</h4> <ul><li>原理​​：通过SVG的rect绘制1px线条。</li> <li>优点​​：支持任意缩放。</li></ul> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.svg-1px</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">&quot;data:image/svg+xml;utf8,&lt;svg xmlns='http://www.w3.org/2000/svg'&gt;&lt;rect width='100%' height='100%' stroke='#000' fill='none'/&gt;&lt;/svg&gt;&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_3、postcss插件-自动化方案-​"><a href="#_3、postcss插件-自动化方案-​" class="header-anchor">#</a> 3、PostCSS插件（自动化方案）​</h4> <p>工具​​：使用PostCSS插件（如postcss-write-svg）自动生成1px边框代码。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// postcss.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'postcss-write-svg'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">utf8</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@svg</span> 1px-border</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
  <span class="token atrule"><span class="token rule">@rect</span></span> <span class="token punctuation">{</span>
    <span class="token property">fill</span><span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">stroke-width</span><span class="token punctuation">:</span> 25%<span class="token punctuation">;</span>
    <span class="token property">stroke</span><span class="token punctuation">:</span> currentColor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token selector">.border</span> <span class="token punctuation">{</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid transparent<span class="token punctuation">;</span>
  <span class="token property">border-image</span><span class="token punctuation">:</span> <span class="token function">svg</span><span class="token punctuation">(</span>1px-border <span class="token function">param</span><span class="token punctuation">(</span>--color #000<span class="token punctuation">)</span><span class="token punctuation">)</span> 1 stretch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="二、h5页面窗口自动调整到设备宽度-并禁止用户缩放页面"><a href="#二、h5页面窗口自动调整到设备宽度-并禁止用户缩放页面" class="header-anchor">#</a> 二、H5页面窗口自动调整到设备宽度，并禁止用户缩放页面</h3> <h4 id="_1-基础设置-viewport-meta-标签​​"><a href="#_1-基础设置-viewport-meta-标签​​" class="header-anchor">#</a> 1. 基础设置：Viewport Meta 标签​​</h4> <p>在HTML的<code>&lt;head&gt;</code>中添加以下meta标签，这是所有解决方案的基础：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="​2-兼容性增强方案​"><a href="#​2-兼容性增强方案​" class="header-anchor">#</a> ​2. 兼容性增强方案​</h4> <p>​**(1) 禁止iOS双击缩放​​**
某些iOS版本会忽略<code>user-scalable=no</code>，需通过JavaScript补充禁止手势：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>touches<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止双指缩放</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">passive</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> lastTouchEnd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastTouchEnd <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止双击缩放</span>
  <span class="token punctuation">}</span>
  lastTouchEnd <span class="token operator">=</span> now<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">passive</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>​​<strong>​(2) 禁止Android手势缩放​​​</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'gesturestart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止Android手势缩放</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="三、移动端click屏幕产生300-ms的延迟响应"><a href="#三、移动端click屏幕产生300-ms的延迟响应" class="header-anchor">#</a> 三、移动端click屏幕产生300 ms的延迟响应</h3> <p><a href="https://www.cnblogs.com/chaojidan/p/4517895.html" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>当用户一次点击屏幕之后，浏览器并不能立刻判断用户是要进行双击缩放，还是想要进行单击操作。因此，就会等待300毫秒，以判断用户是否再次点击了屏幕。</p> <h4 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案：</h4> <ul><li>1、通过 meta 标签禁用网页的缩放</li> <li>2、通过 meta 标签将网页的 viewport 设置为 ideal viewport。</li> <li>3、FastClick</li></ul> <p>FastClick 是 FT Labs 专门为解决移动端浏览器 300 毫秒点击延迟问题所开发的一个轻量级的库。简而言之，FastClick 在检测到 touchend 事件的时候，会通过 DOM 自定义事件立即触发一个模拟click事件的自定义事件，并把浏览器在 300 毫秒之后真正触发的 click 事件阻止掉。</p> <h3 id="四、iphonex的-刘海-底部的安全区域。让页面不能占满屏幕"><a href="#四、iphonex的-刘海-底部的安全区域。让页面不能占满屏幕" class="header-anchor">#</a> 四、iphoneX的“刘海”，底部的安全区域。让页面不能占满屏幕</h3> <p><a href="https://www.zhihu.com/question/66761606" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案：</h4> <p>添加viewport-fit=cover meta标签，使页面占满整个屏幕</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0, viewport-fit=cover<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="五、移动端滚动穿透问题"><a href="#五、移动端滚动穿透问题" class="header-anchor">#</a> 五、移动端滚动穿透问题</h3> <p><a href="https://www.zhihu.com/question/66761606" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>移动端滚动穿透是指当页面弹窗（如模态框、菜单）出现时，用户在弹窗上滑动会导致​​底层页面跟随滚动​​的现象。</p> <h4 id="根本原因"><a href="#根本原因" class="header-anchor">#</a> 根本原因</h4> <ul><li>(1) 事件冒泡机制​​
<ul><li>弹窗的touchmove事件默认冒泡到document，触发底层页面滚动。</li> <li>​关键点​​：浏览器默认允许滚动事件穿透层级。</li></ul></li> <li>​(2) 滚动链（Scroll Chaining）​​
<ul><li>当弹窗内容滚动到顶部/底部时，继续滑动会触发浏览器的滚动链机制，将剩余滚动量传递给父容器（如body）。</li></ul></li> <li>​(3) 平台差异​​
<ul><li>​​iOS橡皮筋效果​​：滑动到边界时触发弹性滚动，直接作用于document。</li> <li>​Android WebView​​：默认优先触发页面级滚动</li></ul></li></ul> <h4 id="解决方案-3"><a href="#解决方案-3" class="header-anchor">#</a> 解决方案</h4> <ul><li>(1) 基础方案：阻止默认事件​</li></ul> <p>适用场景​​：弹窗​​无需内部滚动​​时</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> modal <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.modal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
modal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止默认滚动</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">passive</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须设置 passive: false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>缺点​​：会禁用弹窗内所有滚动</strong></p> <ul><li>(2) 动态阻止边界穿透​，复杂弹窗（推荐）</li></ul> <p>适用场景​​：弹窗​​需要内部滚动​​时</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> startY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
modal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  startY <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientY<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">passive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

modal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentY <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clientY<span class="token punctuation">;</span>
  <span class="token keyword">const</span> scrollTop <span class="token operator">=</span> modal<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isTop <span class="token operator">=</span> <span class="token punctuation">(</span>scrollTop <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> currentY <span class="token operator">&gt;</span> startY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向下滑到顶部</span>
  <span class="token keyword">const</span> isBottom <span class="token operator">=</span> <span class="token punctuation">(</span>scrollTop <span class="token operator">+</span> modal<span class="token punctuation">.</span>offsetHeight <span class="token operator">&gt;=</span> modal<span class="token punctuation">.</span>scrollHeight <span class="token operator">&amp;&amp;</span> currentY <span class="token operator">&lt;</span> startY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向上滑到底部</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isTop <span class="token operator">||</span> isBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止边界穿透</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">passive</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>优点​​：精准控制滚动行为</strong></p> <ul><li>(3) 锁定body滚动​​</li></ul> <p>​​适用场景​​：弹窗覆盖全屏时</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> scrollTop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">openModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scrollTop <span class="token operator">=</span> window<span class="token punctuation">.</span>scrollY<span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'fixed'</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scrollTop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">closeModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> scrollTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>​缺点​​：页面会轻微抖动（跳转位置）</strong></p> <ul><li>​(4) CSS现代属性：overscroll-behavior</li></ul> <p>适用场景​​：兼容现代浏览器（Chrome 63+、Firefox 59+）</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.modal</span> <span class="token punctuation">{</span>
  <span class="token property">overscroll-behavior</span><span class="token punctuation">:</span> contain<span class="token punctuation">;</span> <span class="token comment">/* 阻止滚动链 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>缺点​​：iOS Safari不支持</strong></p> <ul><li>(5) 终极方案：框架集成（如Vant Popup）​，工程化项目（最佳实践）</li></ul> <p>原理​​：动态判断滚动边界，仅在必要时阻止默认事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// React示例</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> originalStyle <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span>overflow<span class="token punctuation">;</span>
  body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflow <span class="token operator">=</span> <span class="token string">'hidden'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflow <span class="token operator">=</span> originalStyle<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="六、​​移动端软键盘遮挡输入框"><a href="#六、​​移动端软键盘遮挡输入框" class="header-anchor">#</a> 六、​​移动端软键盘遮挡输入框</h3> <h4 id="_1-问题原因分析​​"><a href="#_1-问题原因分析​​" class="header-anchor">#</a> 1. 问题原因分析​​</h4> <ul><li>​(1) 视口（Viewport）变化​​
<ul><li>软键盘弹出后，浏览器视口高度减少（通常为原高度的50%-70%）。</li> <li>页面未自动滚动到输入框可见区域。</li></ul></li> <li>​(2) 输入框位置问题​​
<ul><li>绝对定位（position: fixed）的输入框可能被键盘覆盖。</li> <li>输入框位于页面底部时风险更高。</li></ul></li> <li>​(3) 平台差异​​
<ul><li>​iOS​​：键盘弹出会触发resize事件，但可能不会自动滚动。</li> <li>​Android​​：行为碎片化，部分机型需手动处理。</li></ul></li></ul> <h4 id="_2-解决方案"><a href="#_2-解决方案" class="header-anchor">#</a> 2. 解决方案</h4> <ul><li>(1) 自动滚动输入框（通用方案）​</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">focusInput</span><span class="token punctuation">(</span><span class="token parameter">inputElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  inputElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 滚动到输入框位置（兼容iOS/Android）</span>
      inputElement<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        <span class="token literal-property property">behavior</span><span class="token operator">:</span> <span class="token string">'smooth'</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">block</span><span class="token operator">:</span> <span class="token string">'center'</span> <span class="token comment">// 或 'start'/'end'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 延迟确保键盘已弹出</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 对所有输入框生效</span>
document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'input, textarea'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>focusInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>(2) 动态调整布局（针对底部输入框）​</li></ul> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/* CSS：预留键盘高度 */</span>
<span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 50vh<span class="token punctuation">;</span> <span class="token comment">/* 初始预留空间 */</span>
<span class="token punctuation">}</span>

<span class="token selector">.keyboard-active</span> <span class="token punctuation">{</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// JS：检测键盘状态</span>
<span class="token keyword">const</span> inputs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'input, textarea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inputs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">input</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'keyboard-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'keyboard-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>(3) iOS专属修复​</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 修复iOS键盘收起后页面空白</span>
<span class="token keyword">function</span> <span class="token function">fixIOSKeyboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">iPhone|iPad|iPod</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focusout'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">fixIOSKeyboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="七、​​虚拟滚动"><a href="#七、​​虚拟滚动" class="header-anchor">#</a> 七、​​虚拟滚动</h3> <ul><li>基本概念
<ul><li>​可视窗口（Viewport）​​：用户实际看到的区域</li> <li>​滚动容器（Scroll Container）​​：具有固定高度和滚动条的容器</li> <li>​内容容器（Content Container）​​：包含所有元素的虚拟高度容器</li> <li>​渲染窗口（Render Window）​​：实际被渲染的可视区域及缓冲区域</li></ul></li></ul> <img src="/Front-end-go-on/assets/img/vscroll.81631372.png"> <p><strong>核心计算公式</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 计算可见项起始索引</span>
<span class="token keyword">const</span> startIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>scrollTop <span class="token operator">/</span> itemHeight<span class="token punctuation">)</span>
<span class="token comment">// 计算可见项结束索引</span>
<span class="token keyword">const</span> endIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
  startIndex <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>viewportHeight <span class="token operator">/</span> itemHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
  totalItems <span class="token operator">-</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token comment">// 计算内容容器偏移量</span>
<span class="token keyword">const</span> offset <span class="token operator">=</span> startIndex <span class="token operator">*</span> itemHeight
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>主流框架实现</strong></p> <p>React实现（使用react-window）</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> FixedSizeList <span class="token keyword">as</span> List <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-window'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">Row</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> index<span class="token punctuation">,</span> style <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Row </span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">Example</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">List</span></span>
    <span class="token attr-name">height</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">500</span><span class="token punctuation">}</span></span>
    <span class="token attr-name">itemCount</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1000</span><span class="token punctuation">}</span></span>
    <span class="token attr-name">itemSize</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">35</span><span class="token punctuation">}</span></span>
    <span class="token attr-name">width</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">300</span><span class="token punctuation">}</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span>Row<span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">List</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Vue实现（使用vue-virtual-scroller）</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecycleScroller</span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scroller<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:items</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>items<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:item-size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">key-field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ item }<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      {{ item.name }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecycleScroller</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> RecycleScroller <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-virtual-scroller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'vue-virtual-scroller/dist/vue-virtual-scroller.css'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span> RecycleScroller <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> i<span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Item </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_4-h5和app的webview交互"><a href="#_4-h5和app的webview交互" class="header-anchor">#</a> 4.H5和App的Webview交互</h2> <h3 id="一、h5通过ua判断是否在webview环境-追加ua"><a href="#一、h5通过ua判断是否在webview环境-追加ua" class="header-anchor">#</a> 一、H5通过UA判断是否在webview环境（追加UA）</h3> <p>web页面通过脚本能够很容易的拿到浏览器的ua属性，那么在app启动的时候，自定义添加一个ua属性，那么web页面就能够根据这个自定义的ua属性，轻而易举的判断出是否在app内了。</p> <h3 id="二、js和native交互-jsbridge"><a href="#二、js和native交互-jsbridge" class="header-anchor">#</a> 二、JS和Native交互（JSBridge）</h3> <p><a href="https://sevody.github.io/2019/11/10/jsbridge-mechanisms/" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Hybrid APP 即混合模式开发的 APP，它可以把低成本、高效率、跨平台的 H5 技术和追求极致用户体验的 Native 技术混合在一起来为用户提供服务。而 Hybrid 技术实施的前提，是实现 H5 和 Native APP 之间的通信，这个实现，我们称之为 JSBridge。</p> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAbkAAACpCAYAAAC29UMHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAEXRFWHRTb2Z0d2FyZQBTbmlwYXN0ZV0Xzt0AABqzSURBVHic7d15WFV1/gfw970sAmIpqOSG1jCipuY2LpDgCK7PQy5TKqMmckHBAVMhNk0USSYE0QZRh6WyR0VTcFKjCS0sSsUllRQnTNwwl0TSREDg8/uD4CfhgmwXzn2/noc/OOfecz73+vW8Od9z7ueqRERARESkQGptF0BERNRQGHJERKRYDDkiIlIshhwRESkWQ46IiBSLIUdERIrFkCMiIsViyBERkWIx5IiISLEYckREpFgMOSIiUiyGHBERKRZDjoiIFIshR0REisWQIyIixWLIERGRYjHkiIhIsRhyRESkWAw5IiJSLIYcEREpFkOOiIgUiyFHRESKxZAjIiLFYsgREZFiMeSIiEixGHJERKRYDDkiIlIshhwRESkWQ46IiBRLX9sF/NGIESMgItouo0lQqVRIS0vTdhlEBB6bKjS341KTCzkRwYEDB7RdRpNgb2+v7RKI6Hc8NpVrbsclTlcSEZFiMeSIiEixGHJERKRYDDkiIlIshhwRESkWQ46IiBSLIUdERIrFkCMiIsViyBERkWIx5IiISLEYckREpFgMOaIGUlJSgtjYWHh7e+PGjRvaLodIJzHkiBpAbm4uvLy8cP36dUycOBFz5szB119/re2yiHROk/sWAqLmLjU1FTExMfD09MTo0aMBAH/605+wfPlyHDlyBP/4xz9gZGSk5SqJdAPP5IjqSUFBAUJDQ7Fjxw5ER0dXBhwAdOvWDRs3boS+vj7c3d1x7tw5LVZKpDsYckT1ICsrC66urmjfvj3WrVuHTp06VXuMoaEh3nrrLXjO84Sfnx927typhUqJdAtDjqgOysrKsHnzZixZsgR+fn6YM2cO9PWffBXAZpgNYmNjkZ6eDn9/f9zOv91I1RLpHoYcUS3dvHkTixYtwg8//ID4+HgMGDCgxs81NzfH6tWr0a9fP7hp3HDkyJEGrJRId/HGE6Ja+PbbbxEZGYmZb87EpImTarUNlUoFZ2dn9B/QHyHLQ2BnZwc3N7enngkSUc3xTI7oGRQVFSEqKgobN25ERERErQPuYT2seyAuPg55eXnw9PTE5cuX66FSIgIYckQ1dv78ebi7uwMAYmNj8dJLL9Xbtk2MTRAUFISp06bC29sbKSkp9bZtIl3GeRGiGkjelYyPN30MHx8f2NraNth+HB0c8XKvlxESEoKMjAz4+PjA1NS0wfZHpHQ8kyN6gvz8fAQGBiLtqzRs3LixQQOuQocOHRC9LhqdO3eGRqPBDz/80OD7JFIqhhzRYxw/fhwajQa9e/dGVFQU2rVr12j71lPrQaPRIDAwEMuXL8dHH32E0rLSRts/kVIw5Ij+oKKxcnh4OEJDQzF9+nSo1dr5r9KvXz/Ex8cjOzsbCxcsxPXr17VSB1FzxZAjesjDjZUTEhLQs2dPbZeE5557DqGhoXB0dISHhwcOHDig7ZKImg3eeEL0u0c1Vm5KXnvtNfTt2xchISE4cuQIvLy82OiZ6Cl4Jkc670mNlZuabt26YcOGDWjRogU0Gg0bPRM9BUOOdFpWVhZmz54NCwuLxzZWbmoMDQ3h7e0Nb29v+Pn5YceOHdouiajJYsiRTnq4sXJAQADc3d2bXTutoUOHIjY2Ft999x38/PzY6JnoERhypHP+2Fi5f//+2i6p1szNzREZGYkBAwZA46pho2eiP2hef7oS1VF9NFZualQqFaZNm4b+A/pj+bLlGD58ONzc3GBgYKDt0oi0jmdypBMaorFyU2Pd3Rpx8XH49ddfMW/ePDZ6JgJDjnTA+fPn4ebmBqD+Gys3NSbGJggICMC0adMwf/58NnomncfpSlK05F3J2PTRJvj6+jZK38mmwsHBAb169cKKFStw+PBh+Pj4oFWrVtoui6jR8UyOFKmisfKBtAOIjY3VqYCr0KFDB/wr+l+wtLSERqNBZmamtksianQMOVKchxsrr169Gm3bttV2SVqjp9aDq6srFi9ejJCQEDZ6Jp3DkCPFaEqNlZuaV155BQkJCTh37hwWvLWAjZ5JZ/AIQIrQFBsrNzWtWrXCihUrMHr0aMydO5eNnkkn6OyNJ7m5udDX14eFhUWV5VeuXEGLFi0a9bvDqG5SU1Oxbt06zJs3r059J0UE2dnZ6NSpE1q2bAmgfJycPHkSZWVl6N2nN7p17Vb5+NzcXNy7d6/ydwMDA1i8YAETY5PH7uPixYswMzN75E0geXl5uH//foO3FnNyckLfvn2xfPlyZGRkwMvLC8bGxg26T1135coVqFSqav+2165dg1qtRvv27Z9pe08aR1SVzp7JaTQarFq1qtryqVOnIjo6GgCwf/9+mJiYVPnZs2dPY5dKj3Hv3j2Ehobik08+QUxMTJ0bKxcXF8Pa2hrp6ekAgPDwcFhaWiIgIAAzZszASy++hOXLl1c+XqPRoEePHujZsyd69uyJl156Ca2fb41NmzY9dh+Ojo7Yt3/fI9clJCTA29u7Tq+hprp27YoNGzbAyMgIbm5uyM7ObpT96ioXFxdYWVnh0qVLVZZ7eXkhKirqqc///PPPsX79+srfnzSOqCqdDbmaOHXqFJycnJCVlVX5M3LkSG2XVU1ZWRkOHTqEgIAADBgwQNvl1MjAgQPxzjvv1PqOvzNnzkCj0cDCwgIx69ejY8eO9VpfTk4O/P39sWvXLpw6dQq38m5hzZo1WLZsGU6fPl35uEWLFqG0tBSlpaW4d+8e5s+fD09PT5SUlDxyu5s2bcKrtq/Wa6219XCjZ39/f+zYsQMi8szbqRh/gYGBzWL8DRgwAG+//Ta++eYblJQ23k04hYWFmDdvXq2ee+LECXz55ZeVvzelcdTUMeSeIDMzEzY2NujUuTMsLS3RtWtXmJg8fiqqseXn52Pr1q2YNm0atm3bhnHjxsHU1FTbZdWIkZER7OzsEBUVBQ8PD6SlpdXorr+KxspLly6Fv79/eWNlPb16r6/iL+7u1t0BlN+l6OHhgYULF6K4uPiRzzExMYGNjQ2Ki4tR/KAYp06dgp+fHw4ePAhnZ2ccOXIESUlJyMnJAQD8+OOPcHNzw7Bhw+Dp6Ync3NzKbRUVFWHlypVwcHDA9OnTsX37dgQGBlau37d/H6ZMmYJRo0YhMjKyTgfrikbPBw8eLG/0fLtmjZ5v59+uMv7Gjh3bLMafqakpJk6ciL179+KN119HfHw8rl692uD7nTVrFlJTU7Fly5ZHrr969Sq8vLxgY2ODESNGYN26dQDKz/A3b96M9PR0zJw5EyJSOY7eeecdJCYmVm7j559/xowZM5CXl4eSkhKsXr0ajo6OcHZ2xhdffNHgr7Ep0tlrcgBw4cKFKn8dAeXXRSocPXoUhw8fhq+vLwwNDeHp6YmwsDCt9wQ8ffo0du3ahYMHD2Ls2LFYtWoVunbtCgBQq9Wwt7fXan01YWBggFGjRmHUqFE4fvw4tm3bhpiYGEyZMgXjx49/5B8TN2/exLvvvgtjY2PExcWhdevWDVbfgAED0K1bN9gMs4GHhweGDx+OoUOHYvXq1VUeVzGGKq7nRUdHw8PDAybGJrh+4zpiYmKwefNm/P3vf4eFhQV27doFG1sb/PLLL+jfvz8mTJiAoKAgHDhwAJGRkZg0qbzdmEajwbFjxxAaGorc3FxMnz4d3bt3R1hYGFL3pWLCaxMQFRWFdu3aISgoCLm5udVqexbm5uaIiIjA9u3bodFo4O/vjyFDhjzysZmZmfjPf/6Dw4cPY+zYsYiIiIClpSWA5jH+1Go1bG1tYWtri+vXryMlJQXe3t548cUX4eTkBFtb2wb5Rgpra2tERETAw8MDDg4O1e4HcHZ2hlqtRkBAAK5duwYPDw8MHToUPXr0gLW1NdRqNRwdHQGgchy1bNkSoaGhmDZtGgBg9+7dyMzMhJmZGTw9PZGRkYGlS5ciJycHTk5OSE1NhZ2dXb2/tiZNmhg7O7tG2c+YMWPExMREunfvXuXHwMBAli5dKg9KSqRHjx4SHh4uV65ckZSUFDE2Npa1a9c2Sn0i1d+LmzdvyoQJE8TFxUX27NkjBQUFjVZLY8i5kCMRERHi4OAgCR8kVFl37949GTlypCQlJzXY/gsLCwWAfP755yIi8ssvv0hERIT89a9/FQMDA1Gr1TJ79my5e/euiFQfQx07dhSVSiVRUVFSUloiX6R+IQDkyy+/rNyHlZWVJCUnybp166Rz587yoKSkct3EiRNl0qRJkpubKwDk2LFjlev8/f2lV69eIiLi4OAgy5cvl4KCAikoKJADBw6IgYGB/Prrr/XyPpz931l54403ZOvWrVWWX716VSZMmCAajUY+++wzuX//fr3srykoKS2Rb7/7VgICAmTkyJGyZcuWao+py7HJwcFBVq5cKQ9KSmTYsGHi7OwsIiJ/+9vfJCAgQEREVq9eLefOnRMRkfPnz4uhoaHs3r1bRETCwsLk9ddfr9xexTjKuZAjAOTMmTOV+3n//ffl2rVrAkBOnDhROU4WLVokb7zxRq1fQ4XGOkbXF50+k/P09ERERESVZRWdMfT19JCVlVW5vFOnTli4cCFSUlIwf/78Rq2zgp6+Hjp06IAbN24gLy8PBQUFirorLj8/H7du3YKJiQnatG5TZZ1KpYKRkRFu376N0rJS6KnrPkVZWlaKG9dvoG3bttXOzvPz86FWq+Hj4wMfHx8UFhYi5fMUzHpzFtq1a4f33nsPQPUxdOzYMQwePBiDBw8GAOjr62PEiBHV9n3+/HkMGTKkylTrsGHDcOjQIVy4eAEA0KtXr8p1ffr0we7duwEAJ0+exP79+xEcHFxlmxcvXkSfPn1q/4b87tf8X1FYWFjtzr2Ku5Hz8vIqx5+RkVGd99cUFBUV4Xbebdy6dQtt27bF888/3yD70dfTQ3x8PPr06QNnZ+cq63r16oUFCxbgu+++w/PPP4/SGkxBd+vaDQ4ODkhOToaZmRm++uorfPzxxzh//jwAoF+/flUe//LLL9ffi2kmdDrknuTixYtISEhAcHBw5QeKDQ0NUVhYqLWa2rRug/Xr1yM3Nxe7d++Gi4sLBg4ciImTJqLfK+WDecSIEbW6eaCxqVQqpKWloaS0FGlpX2Fb4jYAwLRp0xCyYkW162zGxsZITExEREQEvL28sXTpUrzwwgt1quHWL7fQsWNHHDp0CEOGDEHB/QIA5dNZ//73v7F9+3YcPXoUQPk1xEkTJyFlWgpOnTr12G326dMHRkZGOHnyJKz+bIXWrVtDpVJVe1z79u2rfU6t4pqcmZkZgPJrNBXNpH/66afKx1laWiI4OBguLi4Ayg/Qp0+fRvfu3Wv5TpR78OAB4uLi8M0332BVxCpYd7eusr5du3bYuHEjLl++jD179mDWrFkYPHgwXnvtNbzyyisAmsf4qxh7AHD2f2fx2d7PsH//frz66qvw8vJC3759G3T/PXv2xIoVK+Du7g5ra2v8+c9/xuXLlzF+/HjExsZi2/ZtMDE2QYcOHWq0vdmzZyM0NBQvdHgB48aNQ4cOHVBQUD6Wcy7koK15ecefa9euVfnIi87Q9qnkHzXmdKWPj0+15TY2NrJ06VK5efOmGBgYSFRUlDwoKZEzZ85Iu3btJDIyslHqE3n6e1FUVCT//e9/Zc6cOTJjxgxJSk6SIUOGNFJ1dWNrayuJiYkyadIkCQoKku9PfF/j5+7du1cmTJgg+/btq3MdQ4YMkaCgICksLJTo6GgBIFlns+T48eOiVqslJCSkchrw2LFjYmFhIStXrhSR8jHk6uoq586dk3PnzsmJEydk0aJFolKp5PsT38sXqV9I27Ztq+yvYprp9OnTolKpJOGDBCkuLpb09HQxNjaWSZMmSUlpifTu3VumTp0qubm58vXXX4uJiUnldOU///lPsba2luzsbLl3754EBgbK8OHDpaysrNbvw8WLF0Wj0UhYWJjcK7hXo+cUFhZKSkqKzJkzR2bOnCnJycnNYvzZ2trKp59+Km5ubjJz5kxJSkqSO3fuPPV59TFdWaGoqEj69u0rACQgIEAyMjIEgGRmZsqDBw/kgw8+EACyY8cOEREJDw8Xe3t7uXHjhoj8/zgSEblz544YGhpK586dZdu2bSIiUlpaKv379xcPDw+5e/eu5ObmSv/+/SU6OrrWr6FCc5uu1OmQ8/X1rbbcxsZGli1bJiIiycnJYmZmJmq1WgwMDGTBggVSVFTUKPWJPNt7kXU2S1atWiWOjo4NWFH9cXR0lKioKLl8+XKtnn/p0qVnPig/yt69e8Xa2lpUKpUAkMWLF1euS0pKki5duggA0dfXFwMDA5k/f74UFxeLSPkYAlD5o1KppEePHpKYmCgiIqn7UsXCwqLK/qysrCQ5OVlERDZt2iQtW7YUlUolzz33nIwcOVImT54sIiI//vijDB8+XNRqtXTp0kXmz58v/fr1ExGRgoICmTt3rujp6YlarRY7Ozs5efJknd6DiRMn1umPhqyzWRIeHt4sxp+jo6OEhYVJZmbmMz2vriEXFhZWZdmxY8dErVZLYGCgFBUVyfjx4wWA6OnpyYQJE2TMmDGiVqulrKxM0tPTpWXLlgJASktLq4wjERGNRiNGRkby22+/VS7LOpslAwcOFJVKJcbGxuLi4lI5duuiuYWcSqRpzS3Y29s3qXZDZWVluHHzBtqat22QO66epKm9F03NgwcPEBsbi/T0dAQvC642vfYscnJyYG5ujueee67K8rKyMly7dg2//fYbOnfuXO8fISkrK0NeXh7Mzc2rTGt++OGHGDNmTOX1wqCgIGRnZ+OTTz6pfExxcTEKCwur1VxTd+/eRWRkJG7cuFEv079K1xj/H/Py8mBoaAhTU1OUlJbi7t071a5PP6v8/HwYGxujRYsW9VJjczsu8ZrcU6jVarxgwf/8TZGBgQHmzZuHQYMGITAgEFOnTsWUKVMeeQ3saV588cVHLler1fX+QfM/bv9R35Kwc+dOrF+/HnM95uKncz8hPDwcKZ9X/QJUQ0NDGBoa1mq/mZmZWLFiBcaOHYt3lr5TLzfyUN1VXI8Fym9SqWvAAWjQj9o0B/wwODV7gwcPRnxCPI4ePQpfX1/cunVL2yXVWWJiItzc3HDi+xMwNDTEwYMHMcpxVJ23W1pWio8++gghISFYvHgxXF1dGXCkaDyTI0Vo07oNVq1ahR07dsDd3R1+fn4YOnSotsuqtZYtW8Ld3b1et3n9+nWsWLECbdq0QUJCApv7kk5gyJGivP766+jXrx+WLVuGI0eOYO7cubWe0lOStLQ0rFmzBhqNBk5OTtouh6jRcLqSFMfKygqxsbEoKirC3LlzceHCBW2XpDX379/HqlWrsGnTJqxdu5YBRzqHIUeKZGxsDF9fX7i4uGDhwoWV3UJ0SXZ2Ntzc3GBkZIQNGzZU9jcl0iWcriRFs7e3R48ePRAaGoqMjAy8/fbbtb7lvrkQEezcuRNbtmxp9tcmieqKZ3KkeBYWFlizdg2srKyg0Whw4uQJbZfUYG7fvl359T6xsbEMONJ5DDnSCXpqPcyaNQvBwcFY+e5KJCQk1Oj765qTjIwMaDQaDBo0CBERETA3N9d2SURax5AjndK7d28kJCTg0qVL8Pbyxs8//6ztkurswYMHiImJwZo1axD2zzBMnTq1Vh+IJ1IihhzpHFNTUyxbtgxOTk7w9PTE/v37tV1SrV26dAmenp64c+cO4uLj6tTajEiJeOMJ6axx48ahd+/eCAkJQUZGBt5a8BZMjOu3N2VD+uyzzxAbGwsvLy84ODhouxyiJolncqTTunTpgpiYGLRu3RpuGjec/d9ZbZf0VHfv3sWyZcuwZ88erF+/ngFH9AQMOdJ5BgYG8PT0xMKFC7E4aDESExOb7Bd/ZmZmQqPRwNLSEv+K/he/OYDoKRhyRL/7y1/+grj4OBw/fhw+Pj5NqtFzaVkpPvzwQ4SEhGDJkiVsrExUQww5ooe0ad0G4eHhsLGxgbu7Ow4ePKjtknDt+jW8Nf8t/PTTT0hISEDfvn21XRJRs8EbT4ge4Y+Nnj08PLTS6DktLQ1r166Fq6sr+04S1QLP5Igew8rKCnFxcSguLm70Rs8PN1Zes2YNA46olhhyRE9gZGQEX19fzJ49GwsXLsSnn37a4PtkY2Wi+sPpSqIasLOzg7W1Nd59910cPnwY/v7+9d7omY2Vieofz+SIasjCwgJRa6JgbW0NV1dXnDhRf42e8/LyKhsrx8XFMeCI6gnP5IiegZ5aD2+++SYGDhyIkJAQjB49GrNcXKCvV/vb+Q8fPozw8HBMmTIFU6ZMYd9JonrEMzmiWnj55ZcRHx+PK1euYL63N65evfrM26horPz+++9jZdhKNlYmagAMOaJaMjU1RXBwMJycnDBv3jyk7kut8XMfbqwcGxfLxspEDYTTlUR1NG7cOPTp0wchISE4knEECxYsgInJ4xs9s7EyUePhmRxRPejcuTNiYmJgZmYGNzc3nD1bvdHz3bt3ERwczMbKRI2IIUdUT/T19eHh4YFFixZh8eLF2Lp1K8rKygAAp06dgkajQdduXdlYmagRcbqSqJ4NGjQI8fHxCAsLQ0ZGBoYPH47ExEQsWbKEfSeJGhlDjqgBtG7dGu+99x6SkpKQkZGB+Ph4tGrVSttlEekchhxRA5o8eTImT56s7TKIdBavyRERkWIx5IiISLEYckREpFgMOSIiUiyGHBERKRZDjoiIFIshR0REisWQIyIixWLIERGRYjHkiIhIsRhyRESkWE2ud6VKpYK9vb22y2gSVCqVtksgot/x2FSuuR2XVCIi2i6CiIioIXC6koiIFIshR0REisWQIyIixWLIERGRYjHkiIhIsRhyRESkWAw5IiJSLIYcEREpFkOOiIgUiyFHRESKxZAjIiLFYsgREZFiMeSIiEixGHJERKRYDDkiIlIshhwRESkWQ46IiBSLIUdERIrFkCMiIsViyBERkWIx5IiISLEYckREpFgMOSIiUiyGHBERKRZDjoiIFIshR0REisWQIyIixWLIERGRYjHkiIhIsRhyRESkWAw5IiJSLIYcEREpFkOOiIgUiyFHRESKxZAjIiLFYsgREZFiMeSIiEixGHJERKRYDDkiIlIshhwRESkWQ46IiBSLIUdERIrFkCMiIsViyBERkWL9H5/efgO5zwIjAAAAAElFTkSuQmCC"> <h4 id="h5-调用-native-2-种方式"><a href="#h5-调用-native-2-种方式" class="header-anchor">#</a> H5 调用 Native( 2 种方式)</h4> <ul><li>1.理论上，无论是 iOS 还是 Android，提供的 WebView 容器是可以拦截一切 H5 发起的请求的，无论是标准协议（如 http://、https:// 等）还是私有协议（如 weixin:// ）。基于这个原理，H5 采用私有协议模拟发起 URL 请求，Native 解析这类 URL 并定制相应的处理函数，这就实现了 H5 调用 Native。</li></ul> <img src="/Front-end-go-on/assets/img/native_url.764aba50.png"> <ul><li>2.在 Native 的开发中，开发者可以给 WebView 容器注入全局变量并挂载在 window 对象上，这样前端 js 就可以通过 window 上全局对象方法 来调用一些 Native 的方法。这里需要注意的是方法注入的时机，一般是 WebView 一旦加载页面就需要注入变量。</li></ul> <h4 id="native-调用-h5"><a href="#native-调用-h5" class="header-anchor">#</a> Native 调用 H5</h4> <p>上面提到的给 WebView 容器注入全局变量并挂载在 window 对象上，实际上是 Native 代码执行了一个 evaluateJavaScript 函数，直接运行 js 字符串代码(类似 js 的 eval 函数)，从而实现注入。所以 Native 代码也一样可以通过这个 evaluateJavaScript 函数来调用约定好的 js 函数来实现 H5 的调用。</p> <img src="/Front-end-go-on/assets/img/native_h5.00f048b2.png"> <h4 id="消息都是单向的-调用-native-功能时-callback-的实现原理"><a href="#消息都是单向的-调用-native-功能时-callback-的实现原理" class="header-anchor">#</a> 消息都是单向的，调用 Native 功能时 Callback 的实现原理</h4> <p>JavaScript 是运行在一个单独的 JS Context 中。由于这些 Context 与原生运行环境的天然隔离，我们可以将这种情况与 RPC（Remote Procedure Call，远程过程调用）通信进行类比，将 Native 与 JavaScript 的每次互相调用看做一次 RPC 调用。</p> <p><strong>可以把前端看做 RPC 的客户端，把 Native 端看做 RPC 的服务器端</strong></p> <p>对于 JSBridge 的 Callback ，其实就是 RPC 框架的回调机制。当然也可以用更简单的 JSONP 机制解释：</p> <blockquote><p>当发送 JSONP 请求时，url 参数里会有 callback 参数，其值是 当前页面唯一 的，而同时以此参数值为 key 将回调函数存到 window 上，随后，服务器返回 script 中，也会以此参数值作为句柄，调用相应的回调函数。</p></blockquote> <p>由此可见，callback 参数这个 唯一标识 是这个回调逻辑的关键。这样，我们可以参照这个逻辑来实现 JSBridge：用一个自增的唯一 id，来标识并存储回调函数，并把此 id 以参数形式传递给 Native，而 Native 也以此 id 作为回溯的标识。这样，即可实现 Callback 回调逻辑。</p> <p><strong>完整的H5与原生APP通信的JSBridge解决方案</strong></p> <ul><li><p>一. 通信架构设计</p></li> <li><p>双向通道​​：</p> <ul><li>​H5→APP​​：通过<code>callNative</code>方法调用原生功能</li> <li>​​APP→H5​​：通过<code>onCallback</code>和全局事件监听实现回调</li></ul></li> <li><p>​​平台适配​​：</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Android调用方式</span>
<span class="token function">prompt</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通过prompt协议通信</span>
<span class="token comment">// iOS调用方式</span>
iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'kcnative://go'</span><span class="token punctuation">;</span>     <span class="token comment">// 通过URL Scheme触发</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><table><thead><tr><th>平台</th> <th>触发方式</th> <th>特点</th></tr></thead> <tbody><tr><td>​​Android​</td> <td><code>prompt(JSON.stringify(msg))</code></td> <td>依赖WebView的prompt拦截</td></tr> <tr><td>​​iOS​</td> <td>动态创建iframe触发URL Scheme</td> <td>通过<code>webkit.messageHandlers</code></td></tr></tbody></table> <ul><li>二. 核心通信流程</li></ul> <ol><li>H5调用原生方法（以获取用户token为例）</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>kerkee<span class="token punctuation">.</span><span class="token function">initData</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'获取到的token:'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 实际调用链路：</span>
ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span><span class="token string">'jsBridgeClient'</span><span class="token punctuation">,</span> <span class="token string">'initData'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
↓
<span class="token comment">// Android端：</span>
<span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">'{&quot;clz&quot;:&quot;jsBridgeClient&quot;,&quot;method&quot;:&quot;initData&quot;,&quot;args&quot;:{}}'</span><span class="token punctuation">)</span>
↓
<span class="token comment">// iOS端：</span>
iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'kcnative://go?msg='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>原生调用H5回调</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 原生调用H5注册的回调</span>
ApiBridge<span class="token punctuation">.</span><span class="token function">onCallback</span><span class="token punctuation">(</span>callbackId<span class="token punctuation">,</span> responseData<span class="token punctuation">)</span><span class="token punctuation">;</span>
↓
<span class="token comment">// 触发H5预先注册的回调函数</span>
callbackCache<span class="token punctuation">[</span>callbackId<span class="token punctuation">]</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>三. 关键技术实现</li></ul> <ol><li>消息队列管理</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ApiBridge <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">msgQueue</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment">// 待发送消息队列</span>
  <span class="token literal-property property">callbackCache</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 回调函数缓存</span>
  <span class="token literal-property property">callbackId</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token comment">// 自增ID保证唯一性</span>

  <span class="token function-variable function">callNative</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token punctuation">{</span> clz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> callbackId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbackId<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbackCache<span class="token punctuation">[</span>callbackId<span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span>args<span class="token punctuation">.</span>callbackId <span class="token operator">=</span> callbackId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>msgQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flushMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发消息发送</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>四. 完整代码示例</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> _base64ToArrayBuffer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'UTILS/utils'</span>
<span class="token keyword">import</span> pushOtions <span class="token keyword">from</span> <span class="token string">'UTILS/pushOtions'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'UTILS/Axios'</span>

<span class="token comment">/**
 * 客户端通信交互
 */</span>
<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 避免多次初始化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>WebViewJSBridge<span class="token punctuation">)</span> <span class="token keyword">return</span>
  window<span class="token punctuation">.</span>WebViewJSBridge <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">var</span> browser <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">versions</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> u <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent
      <span class="token keyword">const</span> agents <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'miya'</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>

      <span class="token keyword">let</span> result <span class="token operator">=</span> agents<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">isLocal</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(localhost|10\.|0\.0|192\.168)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">inApp</span><span class="token operator">:</span> result <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">trident</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Trident'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//IE</span>
        <span class="token literal-property property">presto</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Presto'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//opera</span>
        <span class="token literal-property property">webKit</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'AppleWebKit'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//apple&amp;google kernel</span>
        <span class="token literal-property property">gecko</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Gecko'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'KHTML'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//firfox</span>
        <span class="token literal-property property">mobile</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">AppleWebKit.*Mobile.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//is Mobile</span>
        <span class="token literal-property property">ios</span><span class="token operator">:</span>
          <span class="token operator">!</span><span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\(i[^;]+;( U;)? CPU.+Mac OS X</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\(Maci[^;]+; .+Mac OS X</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//is ios</span>
        <span class="token literal-property property">android</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Adr'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//android</span>
        <span class="token literal-property property">iPhone</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'iPhone'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//iPhone or QQHD</span>
        <span class="token literal-property property">iPad</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'iPad'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//iPad</span>
        <span class="token literal-property property">iPod</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'iPod'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//iPod</span>
        <span class="token literal-property property">webApp</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Safari'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//is webapp,no header and footer</span>
        <span class="token literal-property property">weixin</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'MicroMessenger'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//is wechat</span>
        <span class="token literal-property property">qq</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\sQQ</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">' qq'</span><span class="token punctuation">,</span> <span class="token comment">//is qq</span>
        <span class="token literal-property property">PCMiz</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">PCMiz</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token comment">// mizpc</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">language</span><span class="token operator">:</span> <span class="token punctuation">(</span>
      navigator<span class="token punctuation">.</span>browserLanguage <span class="token operator">||</span> navigator<span class="token punctuation">.</span>language
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> isUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'(^|&amp;)'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'=([^&amp;]*)(&amp;|$)'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> r <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> isUrl <span class="token operator">?</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">unescape</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> global <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token operator">||</span> window
  <span class="token keyword">var</span> ApiBridge <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">msgQueue</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">callbackCache</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">callbackId</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">processingMsg</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isReady</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isNotifyReady</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span>bridgeIframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
    ApiBridge<span class="token punctuation">.</span>bridgeIframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span>
    document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>bridgeIframe<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">prepareProcessingMessages</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span>processingMsg <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">fetchMessages</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>msgQueue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> messages <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>msgQueue<span class="token punctuation">)</span>
      ApiBridge<span class="token punctuation">.</span>msgQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">return</span> messages
    <span class="token punctuation">}</span>
    ApiBridge<span class="token punctuation">.</span>processingMsg <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">callNative</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">clz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msgJson <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    msgJson<span class="token punctuation">.</span>clz <span class="token operator">=</span> clz
    msgJson<span class="token punctuation">.</span>method <span class="token operator">=</span> method
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> msgJson<span class="token punctuation">.</span>args <span class="token operator">=</span> args
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> callbackId <span class="token operator">=</span> ApiBridge<span class="token punctuation">.</span><span class="token function">getCallbackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      ApiBridge<span class="token punctuation">.</span>callbackCache<span class="token punctuation">[</span>callbackId<span class="token punctuation">]</span> <span class="token operator">=</span> callback
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msgJson<span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgJson<span class="token punctuation">.</span>args<span class="token punctuation">.</span>callbackId <span class="token operator">=</span> callbackId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        msgJson<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">callbackId</span><span class="token operator">:</span> callbackId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>inApp <span class="token operator">||</span>
      window<span class="token punctuation">.</span>isInApp <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>weixin <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>qq <span class="token operator">&amp;&amp;</span>
        <span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*#\/share?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>bridgeIframe <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ApiBridge<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        ApiBridge<span class="token punctuation">.</span>msgQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msgJson<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ApiBridge<span class="token punctuation">.</span>processingMsg<span class="token punctuation">)</span>
          ApiBridge<span class="token punctuation">.</span>bridgeIframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'kcnative://go'</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>android<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 兼容马甲包</span>
        <span class="token keyword">const</span> agents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'miya'</span><span class="token punctuation">,</span> <span class="token string">'myyw'</span><span class="token punctuation">,</span> <span class="token string">'buou'</span><span class="token punctuation">,</span> <span class="token string">'ppyy'</span><span class="token punctuation">,</span> <span class="token string">'ppkh'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent

        <span class="token keyword">let</span> result <span class="token operator">=</span> agents<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment">// 添加判断，是app可进行跳转。浏览器则不显示弹窗</span>
        result <span class="token operator">&amp;&amp;</span> <span class="token function">prompt</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgJson<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// browser.versions.inApp &amp;&amp; prompt(JSON.stringify(msgJson));</span>
        <span class="token comment">// android</span>
        <span class="token comment">// prompt(JSON.stringify(msgJson));</span>
        <span class="token comment">// prompt(&quot;弹窗&quot;)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">getCallbackId</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ApiBridge<span class="token punctuation">.</span>callbackId<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">onCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callbackId<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>callbackCache<span class="token punctuation">[</span>callbackId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ApiBridge<span class="token punctuation">.</span>callbackCache<span class="token punctuation">[</span>callbackId<span class="token punctuation">]</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">onBridgeInitComplete</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span>
      <span class="token string">'ApiBridge'</span><span class="token punctuation">,</span>
      <span class="token string">'onBridgeInitComplete'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      callback
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">onNativeInitComplete</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span>isReady <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      ApiBridge<span class="token punctuation">.</span>isNotifyReady <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  ApiBridge<span class="token punctuation">.</span><span class="token function-variable function">compile</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">aIdentity<span class="token punctuation">,</span> aJS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value
    <span class="token keyword">var</span> error
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>aJS<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      err<span class="token punctuation">.</span>name <span class="token operator">=</span> e<span class="token punctuation">.</span>name
      err<span class="token punctuation">.</span>message <span class="token operator">=</span> e<span class="token punctuation">.</span>message
      err<span class="token punctuation">.</span>number <span class="token operator">=</span> e<span class="token punctuation">.</span>number <span class="token operator">&amp;</span> <span class="token number">0xffff</span>
      error <span class="token operator">=</span> err
    <span class="token punctuation">}</span>

    ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span><span class="token string">'ApiBridge'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">identity</span><span class="token operator">:</span> aIdentity<span class="token punctuation">,</span>
      <span class="token literal-property property">returnValue</span><span class="token operator">:</span> value<span class="token punctuation">,</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> error
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> _Configs <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">isOpenJSLog</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sysLog</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isOpenNativeXHR</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sysXHR</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  _Configs<span class="token punctuation">.</span>sysLog <span class="token operator">=</span> global<span class="token punctuation">.</span>console<span class="token punctuation">.</span>log
  _Configs<span class="token punctuation">.</span>sysXHR <span class="token operator">=</span> global<span class="token punctuation">.</span>XMLHttpRequest

  <span class="token comment">// js通信交互方法</span>
  <span class="token keyword">var</span> kerkee <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">/*****************************************
   * 事件监听
   *****************************************/</span>
  kerkee<span class="token punctuation">.</span>Event <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  kerkee<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span>
      <span class="token string">'event'</span><span class="token punctuation">,</span>
      <span class="token string">'addEventListener'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">event</span><span class="token operator">:</span> event
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      callback
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  kerkee<span class="token punctuation">.</span><span class="token function-variable function">registerHitPageBottomListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> threshold</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span><span class="token string">'ApiBridge'</span><span class="token punctuation">,</span> <span class="token string">'setHitPageBottomThreshold'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">threshold</span><span class="token operator">:</span> threshold
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    kerkee<span class="token punctuation">.</span>onHitPageBottom <span class="token operator">=</span> callback
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 设备已准备完成
   */</span>
  kerkee<span class="token punctuation">.</span><span class="token function-variable function">onDeviceReady</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span>onDeviceReady <span class="token operator">=</span> handler

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>isReady <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ApiBridge<span class="token punctuation">.</span>isNotifyReady <span class="token operator">&amp;&amp;</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-- device ready --'</span><span class="token punctuation">)</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      ApiBridge<span class="token punctuation">.</span>isNotifyReady <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*****************************************
   * 接口
   *****************************************/</span>
  <span class="token comment">/**
   * 获取客户端用户token
   * @params { Function }, callback 回调
   * @return { Object } ,  { key, player }
   *
   */</span>
  kerkee<span class="token punctuation">.</span><span class="token function-variable function">initData</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span><span class="token string">'jsBridgeClient'</span><span class="token punctuation">,</span> <span class="token string">'initData'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  global<span class="token punctuation">.</span>ApiBridge <span class="token operator">=</span> ApiBridge
  global<span class="token punctuation">.</span>kerkee <span class="token operator">=</span> kerkee
  global<span class="token punctuation">.</span>jsBridgeClient <span class="token operator">=</span> kerkee

  <span class="token comment">// 注册事件，绑定到全局方法</span>
  kerkee<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _window<span class="token punctuation">.</span>ApiBridge <span class="token operator">=</span> window<span class="token punctuation">.</span>ApiBridge
    _window<span class="token punctuation">.</span>kerkee <span class="token operator">=</span> window<span class="token punctuation">.</span>kerkee
    _window<span class="token punctuation">.</span>console<span class="token punctuation">.</span>log <span class="token operator">=</span> window<span class="token punctuation">.</span>console<span class="token punctuation">.</span>log
    _window<span class="token punctuation">.</span>XMLHttpRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest
    _window<span class="token punctuation">.</span>open <span class="token operator">=</span> window<span class="token punctuation">.</span>open
  <span class="token punctuation">}</span>

  <span class="token comment">// 客户端配置 TODO</span>
  ApiBridge<span class="token punctuation">.</span><span class="token function">onBridgeInitComplete</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">aConfigs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>aConfigs<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'isOpenNativeXHR'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _Configs<span class="token punctuation">.</span>isOpenNativeXHR <span class="token operator">=</span> aConfigs<span class="token punctuation">.</span>isOpenNativeXHR
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    ApiBridge<span class="token punctuation">.</span><span class="token function">onNativeInitComplete</span><span class="token punctuation">(</span>ApiBridge<span class="token punctuation">.</span>onDeviceReady<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * h5注册监听服务端⼴播
   * @params { Obejct }, optinos 配置项
   * @params { Function }, callback 回调
   * @return { Object }
   *
   */</span>
  kerkee<span class="token punctuation">.</span><span class="token function-variable function">subscribeAppPush</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cmdId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>onAppPush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function-variable function">onAppPush</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resCmdId<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 客户端返回base64转字节数组</span>
        <span class="token keyword">const</span> arrayBuffer <span class="token operator">=</span> <span class="token function">_base64ToArrayBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

        <span class="token keyword">const</span> index <span class="token operator">=</span> pushOtions<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
          <span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>cmdId <span class="token operator">===</span> resCmdId
        <span class="token punctuation">)</span>
        <span class="token keyword">let</span> resData <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          resData <span class="token operator">=</span> <span class="token function">decode</span><span class="token punctuation">(</span>
            pushOtions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>resDesction<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          resData <span class="token operator">=</span> <span class="token string">'无法解析数据'</span>
        <span class="token punctuation">}</span>

        <span class="token function">callback</span><span class="token punctuation">(</span>resCmdId<span class="token punctuation">,</span> resData<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    ApiBridge<span class="token punctuation">.</span><span class="token function">callNative</span><span class="token punctuation">(</span><span class="token string">'jsBridgeClient'</span><span class="token punctuation">,</span> <span class="token string">'subscribeAppPush'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">cmdId</span><span class="token operator">:</span> cmdId
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br></div></div><h2 id="_5-h5唤起app"><a href="#_5-h5唤起app" class="header-anchor">#</a> 5.H5唤起APP</h2> <p><a href="https://juejin.im/post/6869665966792376327#heading-0" target="_blank" rel="noopener noreferrer">参考地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://github.com/zhuanzhuanfe/call-app" target="_blank" rel="noopener noreferrer">github地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>唤端一般包含了 <strong>唤起App</strong> 、 <strong>下载App</strong> 以及 <strong>唤起App失败后自动下载</strong> 这三个功能。</p> <img src="/Front-end-go-on/assets/img/56d66a02e2d44bd6ac2d5677df1b0fe7_tplv-k3u1fbpfcp-zoom-1.b8ab176e.png"> <p>唤端所使用的技术，通常可以统称为Deep Link（深度链接）技术。不同平台对这项技术有着不同的实现，主流的有这几种：</p> <ul><li>URL Scheme（全平台通用）</li> <li>Universal Link（通用链接，iOS系统专属）</li> <li>App Links 以及衍生的 Chrome Intents（安卓系统专属）</li></ul> <p>当然，以上只是国际通用标准，我们还需要考虑到“国内特色”，包括但不限于微信爸爸、微博、UC浏览器等这些环境的唤端，对于这些App，主流的唤端方式有这么几种</p> <ul><li>Universal Link（部分App可用，快被国内主流App禁干净了）</li> <li>微信API launchApplication 和 getInstallState （需要申请白名单，难度很高）</li> <li>微信开放标签 <em>wx-open-launch-app</em> (微信推荐方式，需要审核，流程较繁琐)</li> <li>跳转到应用宝，然后通过应用宝唤端 （适用于微信安卓环境）</li> <li>弹出个蒙层，友好的提示用户，点击右上角按钮，然后选择在浏览器中打开 （easy~）</li></ul> <img src="/Front-end-go-on/assets/img/5f02a8465aa54ccd9d0bf3f78b5f883b_tplv-k3u1fbpfcp-zoom-1.e496e552.png"> <p>主要介绍下 <strong>URL Scheme</strong>、<strong>Universal Link</strong>、<strong>微信唤端</strong> 和 <strong>自家公司App</strong> 四种技术场景下的唤端实现</p> <ul><li>URL Scheme：</li></ul> <p>URL Scheme其实就是一个URL前面的协议部分，比如这个地址 https://m.zhuanzhuan.com，其中 https就是一个Scheme，代表这是一个https的地址。</p> <p>我们再看一个地址 zhuanzhuan://jump/core/myBuyList/jump?tab=0，当我们访问这个地址的时候，如果系统中有注册 zhuanzhuan:// =&gt; 转转App，那么系统便会使用转转App打开这个链接了，接着App会解析URL的path和search部分，执行对应的操作。</p> <p>那么如何向系统注册 zhuanzhuan 这个Scheme呢，安卓可以在 manifest 里通过 intent-filter 配置，iOS 则可以在 info.plist 文件中添加 URL types 来注册一个 Scheme。</p> <ul><li>Scheme的调用方法：</li></ul> <p>Scheme的调用也十分简单，我们可以通过 <strong>location.href</strong> 或 <strong>iframe</strong> 或 <strong>a标签</strong> 来调用 这三种方式并无本质区别，都是让系统访问一个URL，只不过在某些环境下，当方法失效时，需要采用另一种形式。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// SCHEMA_PATH 为 URL Scheme 地址</span>

<span class="token comment">// location.href 形式</span>
window<span class="token punctuation">.</span>top<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token constant">SCHEMA_PATH</span><span class="token punctuation">;</span>

<span class="token comment">// a标签形式</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">,</span> <span class="token constant">SCHEMA_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// iframe形式</span>
iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iframe<span class="token punctuation">.</span>frameBorder <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>
iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'display:none;border:0;width:0;height:0;'</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">SCHEMA_PATH</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>唤端失败自动下载：</li></ul> <p>使用URL Scheme会遇到一个棘手的问题，那就是我们无法得知是否成功唤起App。这个也可以理解，因为这个方式本质上就是访问一个URL，并没有特别的地方。</p> <p>但是唤端失败（通常是用户没有装这个App），我们需要引导用户去下载，这就要求我们需要通过一些手段，去检测唤端是否成功。</p> <p>常见的做法是通过监听页面是否在 n秒内 隐藏来判断是否成功唤起App，因为如果唤起，那当前页面必然已经退到后台去了。</p> <p>所以我们处理的流程是这样：</p> <p>1、当点击唤端后，定时器延时n秒(我们设定的是2.5秒)后执行下载操作<br>
2、监听 visibilitychange 事件，如果页面隐藏，则表示唤端成功，清除定时器<br>
3、如果 visibilitychange 事件没有被触发，那么就代表唤端失败，n秒后就会执行下载的操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// n秒后执行下载</span>
<span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">__download</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 页面隐藏，那么代表已经调起了app，就清除下载的定时器</span>
<span class="token keyword">const</span> <span class="token function-variable function">visibilitychange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> document<span class="token punctuation">.</span>hidden <span class="token operator">||</span> document<span class="token punctuation">.</span>webkitHidden<span class="token punctuation">;</span>
  tag <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;visibilitychange&quot;</span><span class="token punctuation">,</span> visibilitychange<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;webkitvisibilitychange&quot;</span><span class="token punctuation">,</span> visibilitychange<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;pagehide&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>不过这个方法有个致命问题，就是 n 应该取多少，不同的手机，唤端的时间并不一样。</p> <p>时间设置太长，用户下载等待太久，会导致用户还没看到下载就退出了。
时间设置太短，可能会导致还没有唤起App，就又同时执行了下载的逻辑。</p> <p>这里我们经过测试，觉得n设置为2500ms-3000ms，是一个比较合适的值</p> <h2 id="_6-web-workers-解决主线程阻塞问题"><a href="#_6-web-workers-解决主线程阻塞问题" class="header-anchor">#</a> 6.Web Workers 解决主线程阻塞问题</h2> <p>Web Workers 主要是为了解决 JS 单线程模型带来的性能瓶颈问题</p> <ol><li><p>解决主线程阻塞问题​​：JavaScript 是单线程的，当执行耗时操作（如复杂计算、大数据处理）时会阻塞主线程，导致页面卡顿和无响应。</p></li> <li><p>提升用户体验​​：通过将耗时任务（如图像处理、数据排序、加密解密等）转移到 Worker 线程，确保用户交互（如点击、滚动）能即时响应，避免页面冻结</p></li> <li><p>利用多核 CPU 性能​​：现代浏览器支持多线程并行处理，Web Workers 可以充分发挥多核 CPU 的优势，加速任务执行（如科学计算、3D 渲染）</p></li></ol> <p><strong>限制​​：Worker 线程无法直接操作 DOM，需通过 postMessage 与主线程通信，且受同源策略约束</strong></p> <p>典型应用案例包括：Bilibili 的弹幕处理、在线图片编辑器、金融数据分析工具等</p> <h3 id="示例代码-没做任何优化"><a href="#示例代码-没做任何优化" class="header-anchor">#</a> 示例代码 - 没做任何优化</h3> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>未优化的阻塞示例<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>同步阻塞演示<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 这个按钮在计算完成前不会响应 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>testBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>点击我测试响应<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>output<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>准备开始计算...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 获取DOM元素</span>
    <span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'testBtn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> output <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'output'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 按钮点击事件</span>
    btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      output<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'\n按钮点击已响应!'</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮点击事件处理'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 长时间同步计算函数</span>
    <span class="token keyword">function</span> <span class="token function">blockingCompute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      output<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'计算开始...'</span><span class="token punctuation">;</span>
      <span class="token comment">// 模拟5秒的同步计算</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 纯粹的忙等待循环</span>
      <span class="token punctuation">}</span>
      output<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'\n计算完成!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行计算</span>
    <span class="token function">blockingCompute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这行代码在计算完成后才会执行</span>
    output<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'\n页面脚本执行完毕'</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="代码行为说明"><a href="#代码行为说明" class="header-anchor">#</a> 代码行为说明</h4> <ul><li><ol><li>​​页面加载流程​​：</li></ol> <ul><li>浏览器解析HTML/CSS并渲染初始页面</li> <li>执行JavaScript代码时遇到blockingCompute()</li> <li>主线程被5秒的同步计算完全阻塞</li> <li>计算完成后才会继续执行后续代码</li></ul></li> <li><ol start="2"><li>​用户交互表现​​：</li></ol> <ul><li>在5秒计算期间点击按钮​​不会有任何反应​​</li> <li>控制台​​不会​​立即输出点击日志</li> <li>所有DOM更新​​冻结​​直到计算完成</li></ul></li> <li><ol start="3"><li>​​控制台输出顺序​​：</li></ol> <ul><li>计算开始...</li> <li>计算完成!</li> <li>页面脚本执行完毕</li> <li>(之后点击按钮才会看到)</li> <li>按钮点击已响应!</li></ul></li></ul> <h3 id="示例代码-web-workers优化"><a href="#示例代码-web-workers优化" class="header-anchor">#</a> 示例代码 - Web Workers优化</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>注意：需要使用本地服务器运行html文件</p></div> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 主线程代码 (main.js) --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>非阻塞页面示例<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>页面内容立即显示<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>这个段落和按钮应该立即显示，不受计算影响<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>测试按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 页面元素立即渲染</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'页面已加载，计算进行中...'</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建Web Worker</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'compute.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听计算结果</span>
    worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">计算结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 按钮点击事件 - 会立即响应</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮点击立即响应！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'UI交互未被阻塞'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动计算</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Web Worker代码 (compute.js)</span>
<span class="token comment">// 模拟长时间计算</span>
<span class="token keyword">function</span> <span class="token function">heavyCompute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 模拟5秒计算</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>progress <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每100ms更新一次进度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&gt;</span> progress <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      progress<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">// 向主线程发送进度更新</span>
      self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> progress <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">&quot;计算完成&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 监听主线程消息</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'start'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">heavyCompute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">6/2/2025, 5:44:04 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Front-end-go-on/pages/frontend/frame/base/UniApp.html" class="prev">
        uni-app基础
      </a></span> <span class="next"><a href="/Front-end-go-on/pages/frontend/exercise/Css.html">
        CSS代码练习
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Front-end-go-on/assets/js/app.9707f389.js" defer></script><script src="/Front-end-go-on/assets/js/2.df6f2bda.js" defer></script><script src="/Front-end-go-on/assets/js/1.c1a4e5b8.js" defer></script><script src="/Front-end-go-on/assets/js/19.25243b30.js" defer></script>
  </body>
</html>
