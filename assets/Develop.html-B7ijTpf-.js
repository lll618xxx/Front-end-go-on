import{_ as s,c as a,a as p,o as t}from"./app-Djqxu1EI.js";const e="/Front-end-go-on/assets/serviceworker-amHFGxDb.png",c={};function l(o,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1、谷歌插件概述" tabindex="-1"><a class="header-anchor" href="#_1、谷歌插件概述"><span>1、谷歌插件概述</span></a></h2><p><a href="https://developer.chrome.com/docs/extensions/" target="_blank" rel="noopener noreferrer">插件开发文档，需墙</a></p><h3 id="一、简单介绍" tabindex="-1"><a class="header-anchor" href="#一、简单介绍"><span>一、简单介绍</span></a></h3><p>谷歌插件是运行在Chrome浏览器中的小型软件程序，用于扩展和定制浏览器的功能。<br> 它基于HTML、CSS和JavaScript技术开发，通过manifest.json配置文件定义插件的属性和权限。</p><ul><li>主要功能 <ul><li>内容修改：可以修改网页内容，如添加按钮、移除广告、高亮文本等</li><li>浏览器操作：管理标签页、书签、历史记录，拦截网络请求</li><li>数据存储：在本地存储用户数据，实现个性化设置</li><li>跨域通信：与不同域名的网站进行数据交互</li><li>用户界面：在工具栏添加图标、创建弹出页面、右键菜单选项</li><li>后台任务：定时执行任务、处理事件、发送通知</li></ul></li><li>典型应用场景 <ul><li>广告拦截器（如AdBlock）</li><li>密码管理器（如LastPass）</li><li>网页翻译工具</li><li>开发者工具增强</li><li>社交媒体增强插件</li><li>网页截图工具</li></ul></li></ul><h3 id="二、项目目录结构" tabindex="-1"><a class="header-anchor" href="#二、项目目录结构"><span>二、项目目录结构</span></a></h3><ul><li>manifest.json（必须） <ul><li>插件的“配置文件”，定义了名称、版本、权限、需要加载哪些脚本等核心信息。它使用JSON格式明确告知Chrome插件的能力，例如需要申请哪些权限（如访问特定网站数据、使用存储等），以及指定内容脚本（content_scripts）注入到哪些网页（通过matches字段匹配）</li></ul></li><li>background.js​ (或 service-worker.js) <ul><li>插件的“后台进程”，负责管理生命周期和监听浏览器事件（如标签页更新），即使弹出窗口关闭也能运行。在Manifest V3版本中，它被实现为一个Service Worker。特点是无界面、常驻事件驱动（不持续占用资源）。它常用来设置右键菜单（contextMenus）或管理跨标签页的数据</li></ul></li><li>content.js​ (名称可自定义) <ul><li>“内容脚本”，被注入到特定网页中，用于读取或修改该网页的DOM，实现与页面内容的交互。这些脚本运行在被访问网页的上下文中，可以读取和修改页面的HTML和CSS。但它们与页面自身的JavaScript是隔离的，不能直接访问页面中定义的变量或函数，双方需要通过特殊API进行通信</li></ul></li><li>popup.html​ (名称可自定义) <ul><li>点击浏览器工具栏插件图标后弹出的界面UI，通常伴随有对应的popup.js和popup.css</li></ul></li><li>options.html <ul><li>插件的“设置页面”，用户可以通过右键点击插件图标选择“选项”来打开此页面进行详细配置</li></ul></li></ul><h3 id="三、和普通网页开发的区别" tabindex="-1"><a class="header-anchor" href="#三、和普通网页开发的区别"><span>三、和普通网页开发的区别</span></a></h3><table><thead><tr><th style="text-align:center;">特性维度</th><th style="text-align:center;">普通网页开发</th><th style="text-align:center;">谷歌插件开发</th></tr></thead><tbody><tr><td style="text-align:center;">运行环境与作用域​</td><td style="text-align:center;">在浏览器标签页内运行，受同源策略严格限制，通常只能操作自身页面内容</td><td style="text-align:center;">运行于浏览器的扩展上下文，可跨域访问多个网站，权限范围更广</td></tr><tr><td style="text-align:center;">核心配置文件</td><td style="text-align:center;">通常没有强制要求的根配置文件。</td><td style="text-align:center;">必须包含 manifest.json​ 文件，用于声明插件元数据、权限和核心组件</td></tr><tr><td style="text-align:center;">核心能力与权限</td><td style="text-align:center;">能力有限，主要依赖标准Web API，无法直接调用浏览器底层功能</td><td style="text-align:center;">通过Chrome API可操作标签页、书签、网络请求等，需在manifest.json中声明权限</td></tr><tr><td style="text-align:center;">安全策略</td><td style="text-align:center;">相对宽松，可以执行内联JavaScript（如onclick属性）或使用eval()函数</td><td style="text-align:center;">受严格的内容安全策略 (CSP)​ 约束，默认禁止内联脚本和eval()等不安全操作，资源加载受限</td></tr><tr><td style="text-align:center;">生命周期与资源加载</td><td style="text-align:center;">页面打开时加载，关闭时销毁；资源通常从远程服务器加载</td><td style="text-align:center;">组件有独立生命周期（如Service Worker事件驱动、Popup随点击打开）；代码和资源通常从本地打包文件加载</td></tr></tbody></table><ul><li>调试工具：两者都使用Chrome开发者工具，但调试入口不同。 <ul><li>插件后台Service Worker：在扩展管理页面点击对应插件的“查看视图”下的“Service Worker”链接进行调试。</li><li>插件弹出页(Popup)：右键点击浏览器工具栏上的插件图标，选择“检查”来调试Popup界面。</li><li>插件内容脚本(Content Scripts)：在目标网页的开发者工具中，切换到“Sources”页签，在“Content scripts”栏下找到并调试</li></ul></li></ul><h2 id="_2、manifest-v3特性" tabindex="-1"><a class="header-anchor" href="#_2、manifest-v3特性"><span>2、Manifest V3特性</span></a></h2><p>V2在2023年的时候已经停用。</p><table><thead><tr><th style="text-align:center;">特性类别</th><th style="text-align:center;">Manifest V2</th><th style="text-align:center;">Manifest V3</th><th style="text-align:center;">核心变化与影响</th></tr></thead><tbody><tr><td style="text-align:center;">架构核心</td><td style="text-align:center;">后台页面 (Background Page)</td><td style="text-align:center;">服务工作者 (Service Worker)​</td><td style="text-align:center;">从持久运行的页面变为事件驱动、可被浏览器终止的工作线程。</td></tr><tr><td style="text-align:center;">网络请求处理</td><td style="text-align:center;">webRequestAPI (命令式)</td><td style="text-align:center;">declarativeNetRequestAPI​ (声明式)</td><td style="text-align:center;">扩展声明规则，浏览器负责执行，无需读取请求内容，更隐私安全</td></tr><tr><td style="text-align:center;">代码执行</td><td style="text-align:center;">允许远程托管的代码</td><td style="text-align:center;">禁止远程代码​</td><td style="text-align:center;">所有逻辑必须打包在扩展内，提高安全性和可审查性。</td></tr><tr><td style="text-align:center;">API 风格​</td><td style="text-align:center;">普遍依赖回调 (Callbacks)</td><td style="text-align:center;">广泛支持 Promise​</td><td style="text-align:center;">支持现代异步编程模式，如 async/await，代码更简洁。</td></tr><tr><td style="text-align:center;">权限管理</td><td style="text-align:center;">权限混合声明</td><td style="text-align:center;">权限细分​</td><td style="text-align:center;">主机权限 (host_permissions) 与 API 权限 (permissions) 分离，声明更清晰。</td></tr><tr><td style="text-align:center;">界面操作</td><td style="text-align:center;">分离的 browser_action和 page_action</td><td style="text-align:center;">统一的 actionAPI​</td><td style="text-align:center;">简化了扩展图标及其相关弹出页面 (popup) 的定义</td></tr></tbody></table><p>⚙️ 深入核心特性</p><h3 id="一、生命周期管理" tabindex="-1"><a class="header-anchor" href="#一、生命周期管理"><span>一、生命周期管理</span></a></h3><ul><li><code>Service Worker</code> 是事件驱动的，在不处理事件时会被浏览器终止（通常闲置约30秒后）以节省资源 。这意味着不能依赖全局变量来持久化状态。</li><li>所有需要跨事件保存的数据都必须使用 <code>chrome.storageAPI</code> 或 <code>IndexedDB</code></li></ul><h3 id="二、环境差异" tabindex="-1"><a class="header-anchor" href="#二、环境差异"><span>二、环境差异</span></a></h3><ul><li><code>Service Worker</code> 运行在一个独立的环境中，没有 DOM 访问权限，也不能使用 <code>XMLHttpRequest</code>，必须使用现代的 <code>fetch()API</code> 进行网络请求</li></ul><h3 id="三、声明式网络请求" tabindex="-1"><a class="header-anchor" href="#三、声明式网络请求"><span>三、声明式网络请求</span></a></h3><ul><li><code>declarativeNetRequestAPI</code> 的工作方式是：扩展预定义一组规则（匹配条件和操作），浏览器直接应用这些规则，扩展本身不介入每个请求的实时处理 。这避免了扩展需要读取所有网络请求内容的需求，保护了用户隐私。</li></ul><h3 id="四、远程代码禁令与应对策略" tabindex="-1"><a class="header-anchor" href="#四、远程代码禁令与应对策略"><span>四、远程代码禁令与应对策略</span></a></h3><ul><li>此规则禁止从远程服务器加载 JavaScript 或 Wasm 文件，也禁止执行动态字符串代码（如 eval()）这确保了提交到 Chrome 应用商店的扩展行为是固定的，便于安全审查。</li><li>如果业务逻辑需要更新，官方推荐的替代方案是远程配置。扩展可以定期从服务器获取 JSON 等格式的配置文件，然后由扩展包内预置的、安全的逻辑来解析和执行这些配置</li></ul><h3 id="五、处理长时间任务" tabindex="-1"><a class="header-anchor" href="#五、处理长时间任务"><span>五、处理长时间任务</span></a></h3><ul><li>由于 <code>Service Worker</code> 会被终止，需要执行周期性任务时应使用 <code>chrome.alarmsAPI</code>。对于极少数需要 DOM 访问的后台任务，可考虑使用 <code>chrome.offscreenAPI</code> 创建离屏文档</li></ul><h2 id="_3、manifest-json字段详解" tabindex="-1"><a class="header-anchor" href="#_3、manifest-json字段详解"><span>3、manifest.json字段详解</span></a></h2><ul><li>必填字段 <ul><li>manifest_version：清单版本号，目前主流为v2和v3版本，v3是当前推荐标准</li><li>name：插件名称，字符串类型，必填字段</li><li>version：插件版本号，字符串类型，必填字段</li></ul></li><li>基本信息字段 <ul><li>description：插件功能描述，字符串类型</li><li>icons：插件图标配置，包含不同尺寸的图标文件路径，建议提供16x16、32x32、48x48、128x128像素的图标</li><li>author：插件作者信息，可包含email等联系方式</li></ul></li><li>权限配置字段 <ul><li>permissions：控制扩展能访问哪些Chrome API：如storage、tabs、activeTab、notifications等</li></ul><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// 存储数据</span></span>
<span class="line">    <span class="token string">&quot;tabs&quot;</span><span class="token punctuation">,</span>              <span class="token comment">// 访问标签页</span></span>
<span class="line">    <span class="token string">&quot;bookmarks&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// 书签操作</span></span>
<span class="line">    <span class="token string">&quot;notifications&quot;</span><span class="token punctuation">,</span>     <span class="token comment">// 桌面通知</span></span>
<span class="line">    <span class="token string">&quot;activeTab&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// 当前标签页临时权限</span></span>
<span class="line">    <span class="token string">&quot;scripting&quot;</span><span class="token punctuation">,</span>         <span class="token comment">// 脚本注入</span></span>
<span class="line">    <span class="token string">&quot;alarms&quot;</span>             <span class="token comment">// 定时任务</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>host_permissions：声明插件可访问的主机域名权限，使用URL匹配模式</li></ul><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line">    <span class="token property">&quot;host_permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;https://example.com/*&quot;</span><span class="token punctuation">,</span>           <span class="token comment">// 特定域名</span></span>
<span class="line">    <span class="token string">&quot;https://*.google.com/*&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// 子域名通配符</span></span>
<span class="line">    <span class="token string">&quot;https://*/api/*&quot;</span><span class="token punctuation">,</span>                 <span class="token comment">// 路径匹配</span></span>
<span class="line">    <span class="token string">&quot;http://localhost:*/*&quot;</span><span class="token punctuation">,</span>            <span class="token comment">// 本地开发服务器</span></span>
<span class="line">    <span class="token string">&quot;&lt;all_urls&gt;&quot;</span>                       <span class="token comment">// 所有网址（谨慎使用）</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>optional_permissions：运行时由用户授予的可选权限</li><li>optional_host_permissions：运行时由用户授予的可选主机权限</li></ul></li><li>核心功能字段 <ul><li>action：定义插件在浏览器工具栏中的行为，包括图标、标题和弹出页面</li><li>background：定义后台脚本或页面，用于处理全局事件、管理状态等</li><li>content_scripts：定义注入到匹配页面的脚本和样式表，可指定注入时机和匹配规则</li><li>web_accessible_resources：定义插件中可供网页或其他插件访问的资源文件</li></ul></li><li>其他常用字段 <ul><li>options_page：插件设置页面</li><li>commands：定义快捷键命令</li><li>content_security_policy：定义内容安全策略</li><li>default_locale：默认本地化设置</li><li>update_url：插件更新地址</li></ul></li></ul><h2 id="_4、popup-和-options-页面" tabindex="-1"><a class="header-anchor" href="#_4、popup-和-options-页面"><span>4、Popup 和 Options 页面</span></a></h2><table><thead><tr><th style="text-align:center;">特性</th><th style="text-align:center;">Popup (弹出页面)</th><th style="text-align:center;">Options Page (选项页面)</th></tr></thead><tbody><tr><td style="text-align:center;">主要用途</td><td style="text-align:center;">临时性交互，快速操作</td><td style="text-align:center;">插件配置和设置，功能更复杂</td></tr><tr><td style="text-align:center;">触发方式</td><td style="text-align:center;">用户点击浏览器工具栏中的插件图标</td><td style="text-align:center;">用户右键点击插件图标选择“选项”，或在扩展管理页面点击“选项”</td></tr><tr><td style="text-align:center;">生命周期</td><td style="text-align:center;">短暂，焦点离开页面即关闭</td><td style="text-align:center;">持久，作为独立标签页或弹窗存在</td></tr><tr><td style="text-align:center;">配置方式</td><td style="text-align:center;">在 manifest.json的 action字段中设置 default_popup</td><td style="text-align:center;">在 manifest.json中使用 options_page或更现代的 options_ui</td></tr><tr><td style="text-align:center;">页面能力</td><td style="text-align:center;">能力受限，适合简单交互</td><td style="text-align:center;">完整的网页能力，可构建复杂界面</td></tr><tr><td style="text-align:center;">打开方式</td><td style="text-align:center;">无法通过程序代码打开，只能用户点击</td><td style="text-align:center;">可通过 chrome.runtime.openOptionsPage()编程方式打开</td></tr></tbody></table><h2 id="_5、background-scripts-service-worker" tabindex="-1"><a class="header-anchor" href="#_5、background-scripts-service-worker"><span>5、Background Scripts(Service Worker)</span></a></h2><p>Manifest V3 的 Background Scripts 是运行在 Service Worker 环境中的。<br> Service Worker 是 Manifest V3 中替代后台页面的技术，它是一个在浏览器后台独立运行的 JavaScript 文件，可以拦截和处理网络请求、管理缓存、接收推送消息等。</p><p><strong>关键点：无持久状态、事件驱动、随时可能终止</strong></p><table><thead><tr><th style="text-align:center;">特性</th><th style="text-align:center;">Manifest V2 Background</th><th style="text-align:center;">Manifest V3 Service Worker</th></tr></thead><tbody><tr><td style="text-align:center;">运行环境</td><td style="text-align:center;">后台页面（有DOM）</td><td style="text-align:center;">Service Worker（无DOM）</td></tr><tr><td style="text-align:center;">生命周期</td><td style="text-align:center;">可持久运行</td><td style="text-align:center;">事件驱动，可能被终止</td></tr><tr><td style="text-align:center;">文件配置</td><td style="text-align:center;">页面或脚本数组</td><td style="text-align:center;">单个Service Worker文件</td></tr><tr><td style="text-align:center;">调试方式​</td><td style="text-align:center;">chrome://extensions中打开</td><td style="text-align:center;">chrome://serviceworker-internals</td></tr></tbody></table><ul><li>✅ Service Worker 应该处理： <ul><li>事件监听：tabs.onUpdated、downloads.onCreated</li><li>定时任务：chrome.alarms</li><li>消息中转：不同页面间的通信</li><li>数据同步：本地↔服务器同步</li><li>推送通知：chrome.notifications</li></ul></li></ul><h3 id="生命周期" tabindex="-1"><a class="header-anchor" href="#生命周期"><span>生命周期</span></a></h3><img src="`+e+`" style="width:300px;"><ul><li><ol><li>Installing 状态</li></ol></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 安装阶段 - 只发生一次</span></span>
<span class="line">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;install&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 安装中...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 跳过等待，立即激活</span></span>
<span class="line">  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// 预缓存关键资源</span></span>
<span class="line">    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#39;v1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;/styles.css&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;/app.js&#39;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 强制进入激活状态</span></span>
<span class="line">      <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><ol start="2"><li>Installed/Waiting 状态</li></ol><ul><li>已安装但未激活</li><li>等待旧的 <code>Service Worker</code> 控制的所有客户端关闭</li><li>可通过 <code>skipWaiting()</code>立即激活</li></ul></li><li><ol start="3"><li>Activating 状态</li></ol></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 激活阶段</span></span>
<span class="line">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;activate&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 激活中...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// 清理旧缓存</span></span>
<span class="line">    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cacheNames</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span></span>
<span class="line">        cacheNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheName <span class="token operator">!==</span> <span class="token string">&#39;v1&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 立即控制所有客户端</span></span>
<span class="line">      <span class="token keyword">return</span> self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><ol start="4"><li>Active 状态</li></ol></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 激活后，开始处理事件</span></span>
<span class="line">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;fetch&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span></span>
<span class="line">    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> response <span class="token operator">||</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><ol start="5"><li>Terminated 状态</li></ol><ul><li>空闲时自动终止</li><li>Chrome 会在 30 秒空闲后终止</li><li>下次事件触发时重新启动</li><li><strong>所有变量状态都会丢失</strong></li></ul></li></ul><h3 id="无持久化状态" tabindex="-1"><a class="header-anchor" href="#无持久化状态"><span>无持久化状态</span></a></h3><p>❌ 错误理解：认为 Service Worker 可以像普通页面一样保持变量值</p><p>✅ 正确理解：Service Worker <strong>每次启动时都是全新的运行环境，所有内存状态都会重置</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ❌ 错误示例：状态会丢失</span></span>
<span class="line"><span class="token keyword">let</span> requestCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次Service Worker重启都会归零</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ✅ 正确示例：使用持久化存储</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">incrementCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;requestCount&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>requestCount <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">requestCount</span><span class="token operator">:</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> count<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用示例</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;TRACK_REQUEST&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> newCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">incrementCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ✅ 正确的状态管理</span></span>
<span class="line">    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> newCount <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>实际影响 <ul><li>不能依赖全局变量：每次启动都是从零开始</li><li>必须使用存储API：chrome.storage、IndexedDB、Cache API</li><li>初始化成本：每次启动都需要重新加载数据</li></ul></li></ul><h3 id="事件驱动" tabindex="-1"><a class="header-anchor" href="#事件驱动"><span>事件驱动</span></a></h3><p>❌ 错误理解：认为 Service Worker 可以主动轮询或持续运行<br> ✅ 正确理解：Service Worker 只能被动响应事件，不能主动执行代码</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ❌ 错误示例：主动轮询（不会有效）</span></span>
<span class="line"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">checkForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Service Worker 终止后定时器就没了</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ✅ 正确示例：使用事件监听</span></span>
<span class="line"><span class="token comment">// 1. 监听消息事件</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;CHECK_UPDATES&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">checkForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. 使用chrome.alarms（chrome会唤醒Service Worker）</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&#39;checkUpdates&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">periodInMinutes</span><span class="token operator">:</span> <span class="token number">30</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span>onAlarm<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">alarm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>alarm<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;checkUpdates&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">checkForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. 监听浏览器事件</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onUpdated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tabId<span class="token punctuation">,</span> changeInfo<span class="token punctuation">,</span> tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>changeInfo<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">handleUrlChange</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>事件类型 <ul><li>扩展事件：onMessage, onConnect</li><li>浏览器事件：tabs.onCreated, webRequest.onBeforeRequest</li><li>定时事件：alarms.onAlarm</li><li>网络事件：fetch（普通网页SW用）</li></ul></li></ul><h3 id="随时可能终止" tabindex="-1"><a class="header-anchor" href="#随时可能终止"><span>随时可能终止</span></a></h3><p>❌ 错误理解：认为 Service Worker 启动后会一直运行<br> ✅ 正确理解：Chrome 会在 Service Worker 空闲约30秒后自动终止它</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ❌ 错误示例：假设Service Worker会持续运行</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">startLongRunningProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 这个处理如果超过30秒，可能被中断</span></span>
<span class="line">  <span class="token function">processLargeDataset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ✅ 正确示例：分块处理 + 状态保存</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processLargeDatasetSafely</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> chunk <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 处理当前块</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">processChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 保存进度</span></span>
<span class="line">    <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">processingProgress</span><span class="token operator">:</span> i <span class="token operator">+</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">lastProcessed</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 如果这是最后一块，清理进度</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> chunkSize <span class="token operator">&gt;=</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;processingProgress&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 恢复中断的任务</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resumeInterruptedTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;processingProgress&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>processingProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;恢复任务，从进度&#39;</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>processingProgress<span class="token punctuation">,</span> <span class="token string">&#39;继续&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">processLargeDatasetSafely</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>终止时机 <ul><li>30秒空闲：无事件处理时</li><li>内存压力：系统内存不足时</li><li>浏览器关闭：用户关闭浏览器时</li><li>扩展更新：扩展更新时</li></ul></li></ul><h3 id="启动时机" tabindex="-1"><a class="header-anchor" href="#启动时机"><span>启动时机</span></a></h3><p>Service Worker 的启动是事件驱动的，只有在特定事件发生时才会启动</p><h4 id="_1-扩展相关事件" tabindex="-1"><a class="header-anchor" href="#_1-扩展相关事件"><span>1. 扩展相关事件</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// Service Worker 会在以下事件发生时启动：</span></span>
<span class="line"><span class="token comment">// 1️⃣ 扩展安装/更新</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">details</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 因扩展安装/更新而启动&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// details.reason 可能是：</span></span>
<span class="line">  <span class="token comment">// - &#39;install&#39;     (首次安装)</span></span>
<span class="line">  <span class="token comment">// - &#39;update&#39;      (扩展更新)</span></span>
<span class="line">  <span class="token comment">// - &#39;chrome_update&#39; (浏览器更新)</span></span>
<span class="line">  <span class="token comment">// - &#39;shared_module_update&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-api-事件监听" tabindex="-1"><a class="header-anchor" href="#_2-api-事件监听"><span>2. API 事件监听</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 2️⃣ 监听的事件被触发时</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onUpdated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tabId<span class="token punctuation">,</span> changeInfo<span class="token punctuation">,</span> tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 因标签页更新而启动&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 因收到消息而启动&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 保持通道开放</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">port</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 因建立连接而启动&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-定时器事件" tabindex="-1"><a class="header-anchor" href="#_3-定时器事件"><span>3. 定时器事件</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 3️⃣ 注册的定时器触发</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span>onAlarm<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">alarm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 因定时器触发而启动&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建定时器</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&#39;dailyCheck&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">periodInMinutes</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span>  <span class="token comment">// 每天触发</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-浏览器事件" tabindex="-1"><a class="header-anchor" href="#_4-浏览器事件"><span>4. 浏览器事件</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 4️⃣ 浏览器事件触发</span></span>
<span class="line">chrome<span class="token punctuation">.</span>webRequest<span class="token punctuation">.</span>onBeforeRequest<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token parameter">details</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Service Worker 因网络请求而启动&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> <span class="token literal-property property">urls</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;all_urls&gt;&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="启动时间轴示例" tabindex="-1"><a class="header-anchor" href="#启动时间轴示例"><span>启动时间轴示例</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 用户一天的典型使用场景：</span></span>
<span class="line"><span class="token number">8</span><span class="token operator">:</span><span class="token number">00</span> 打开浏览器 → ❌ Service Worker 未启动</span>
<span class="line"><span class="token number">8</span><span class="token operator">:</span><span class="token number">05</span> 点击扩展图标 → ✅ 启动（chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage）</span>
<span class="line"><span class="token number">8</span><span class="token operator">:</span><span class="token number">10</span> 访问新网页 → ✅ 启动（chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onUpdated）</span>
<span class="line"><span class="token number">8</span><span class="token operator">:</span><span class="token number">30</span> 定时任务 → ✅ 启动（chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span>onAlarm）</span>
<span class="line"><span class="token number">8</span><span class="token operator">:</span><span class="token number">35</span> 关闭浏览器 → ❌ Service Worker 终止</span>
<span class="line"><span class="token number">14</span><span class="token operator">:</span><span class="token number">00</span> 重新打开浏览器 → ❌ Service Worker 未启动</span>
<span class="line"><span class="token number">14</span><span class="token operator">:</span><span class="token number">05</span> 收到推送 → ✅ 启动（chrome<span class="token punctuation">.</span>gcm<span class="token punctuation">.</span>onMessage）</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="无法直接访问-dom" tabindex="-1"><a class="header-anchor" href="#无法直接访问-dom"><span>无法直接访问 DOM</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ❌ 错误：无法访问</span></span>
<span class="line">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;element&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ✅ 正确：通过消息传递</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;UPDATE_DOM&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 发送消息给content script处理</span></span>
<span class="line">    chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&#39;updateElement&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">data</span><span class="token operator">:</span> request<span class="token punctuation">.</span>data</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="消息路由中心" tabindex="-1"><a class="header-anchor" href="#消息路由中心"><span>消息路由中心</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 接收来自 content scripts 的消息</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;收到消息:&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    request<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">sender</span><span class="token operator">:</span> sender<span class="token punctuation">.</span>tab<span class="token operator">?.</span>url<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">senderTabId</span><span class="token operator">:</span> sender<span class="token punctuation">.</span>tab<span class="token operator">?.</span>id</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// 处理不同类型的消息</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;GET_DATA&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 异步处理示例</span></span>
<span class="line">    <span class="token function">handleGetData</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> sender<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sendResponse<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 必须返回 true 以支持异步响应</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;PERFORM_ACTION&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">performAction</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// 如果没有处理，不需要返回 true</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 与 popup 的专用通信通道</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>port<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;popup&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;来自 popup 的消息:&#39;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;PING&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;PONG&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">time</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  port<span class="token punctuation">.</span>onDisconnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Popup 断开连接&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="定时任务管理" tabindex="-1"><a class="header-anchor" href="#定时任务管理"><span>定时任务管理</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 创建定时器</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&#39;periodicTask&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">periodInMinutes</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>  <span class="token comment">// 每小时执行一次</span></span>
<span class="line">  <span class="token literal-property property">delayInMinutes</span><span class="token operator">:</span> <span class="token number">1</span>     <span class="token comment">// 1分钟后首次执行</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 监听定时器触发</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span>onAlarm<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">alarm</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>alarm<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;periodicTask&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;执行定时任务&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">performPeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 一次性定时器</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&#39;oneTimeTask&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">when</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5000</span>  <span class="token comment">// 5秒后执行</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 销毁特定的定时器</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token string">&#39;callApi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 销毁所有定时器</span></span>
<span class="line">chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6、content-scripts" tabindex="-1"><a class="header-anchor" href="#_6、content-scripts"><span>6、content scripts</span></a></h2><p>Content Scripts​ 是 Chrome 扩展的核心组件，允许将 JavaScript 和 CSS 代码注入到特定的网页中，与页面内容直接交互。</p><h3 id="一、核心特性" tabindex="-1"><a class="header-anchor" href="#一、核心特性"><span>一、核心特性</span></a></h3><ul><li><ol><li>运行环境</li></ol><ul><li>运行在网页的上下文中，能够访问和操作 DOM</li><li>但与网页的 JavaScript 环境隔离，有自己的独立作用域</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 在 content script 中</span></span>
<span class="line"><span class="token keyword">var</span> pageVar <span class="token operator">=</span> <span class="token string">&quot;这是 content script 的变量&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 网页的 JavaScript 无法直接访问这个变量</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 网页中的变量</span></span>
<span class="line"><span class="token comment">// var pageVar = &quot;这是网页的变量&quot;;</span></span>
<span class="line"><span class="token comment">// content script 也无法直接访问</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>可以访问部分 Chrome API（通过扩展 API）</li></ul></li></ul><h3 id="二、配置方式" tabindex="-1"><a class="header-anchor" href="#二、配置方式"><span>二、配置方式</span></a></h3><h4 id="_1-静态声明-manifest-json" tabindex="-1"><a class="header-anchor" href="#_1-静态声明-manifest-json"><span>1. 静态声明 (manifest.json)</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;content_scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://*.example.com/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;css&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;styles.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;content.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;run_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;document_idle&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 注入时机</span></span>
<span class="line">      <span class="token string-property property">&quot;match_about_blank&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;all_frames&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-动态注入-通过-background-js" tabindex="-1"><a class="header-anchor" href="#_2-动态注入-通过-background-js"><span>2. 动态注入 (通过 background.js)</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 在 background.js 或 popup.js 中</span></span>
<span class="line">chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">tabId</span><span class="token operator">:</span> tab<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;content.js&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、与页面通信" tabindex="-1"><a class="header-anchor" href="#三、与页面通信"><span>三、与页面通信</span></a></h3><h4 id="_1-dom-事件通信" tabindex="-1"><a class="header-anchor" href="#_1-dom-事件通信"><span>1. DOM 事件通信</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// content script 发送消息</span></span>
<span class="line">window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;FROM_CONTENT_SCRIPT&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">&quot;Hello from content script&quot;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 网页监听消息</span></span>
<span class="line">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;FROM_CONTENT_SCRIPT&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-与扩展其他部分通信" tabindex="-1"><a class="header-anchor" href="#_2-与扩展其他部分通信"><span>2. 与扩展其他部分通信</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 与 background script 通信</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token punctuation">{</span> <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&quot;logData&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">&quot;some data&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token parameter">response</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Response:&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 监听来自 background 的消息</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;updateContent&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 更新页面内容</span></span>
<span class="line">    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="四、访问-chrome-api-的权限" tabindex="-1"><a class="header-anchor" href="#四、访问-chrome-api-的权限"><span>四、访问 Chrome API 的权限</span></a></h3><ul><li>Content scripts 可以访问有限的 Chrome API： <ul><li>chrome.runtime（发送消息、获取扩展信息）</li><li>chrome.storage（存储数据）</li><li>chrome.i18n（国际化）</li></ul></li><li>不能访问： <ul><li>chrome.tabs（部分权限）</li><li>chrome.windows -需要更高权限的 API</li></ul></li></ul><h3 id="五、隔离突破" tabindex="-1"><a class="header-anchor" href="#五、隔离突破"><span>五、隔离突破</span></a></h3><p>在 Content Scripts 中，world​ 定义了脚本执行的 JavaScript 隔离环境。Chrome 94+ 引入了两种 world：</p><ul><li>1、&quot;ISOLATED&quot;（默认）：隔离世界</li><li>2、&quot;MAIN&quot;：主世界（网页的 JS 环境） 核心作用：共享网页的 JavaScript 环境</li></ul><ul><li>使用 world: &quot;MAIN&quot;让你能够： <ul><li>✅ 直接访问网页的 JavaScript 对象和函数</li><li>✅ 修改网页的全局变量</li><li>✅ 与网页框架（React、Vue 等）直接交互</li></ul></li><li>但要小心： <ul><li>⚠️ 可能引起命名冲突</li><li>⚠️ 降低扩展的安全性</li><li>⚠️ 可能破坏网页功能</li></ul></li></ul><p>建议：只有在确实需要与网页 JavaScript 深度交互时才使用 &quot;MAIN&quot;，并采取适当的防护措施。</p><h3 id="六、与浏览器插件通信" tabindex="-1"><a class="header-anchor" href="#六、与浏览器插件通信"><span>六、与浏览器插件通信</span></a></h3><p>Content Scripts 与插件其他部分（popup、background、options等）通过 消息传递​ 机制通信，主要有三种方式：</p><ul><li><ol><li>chrome.runtime.sendMessage()​ - 一次性消息</li></ol></li><li><ol start="2"><li>chrome.runtime.connect()​ - 长连接通信</li></ol></li><li><ol start="3"><li>DOM 事件​ - 与网页脚本通信</li></ol></li></ul><h4 id="_1-一次性消息传递-最常用" tabindex="-1"><a class="header-anchor" href="#_1-一次性消息传递-最常用"><span>1. 一次性消息传递（最常用）</span></a></h4><p>Content Script → Background/Popup</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// content-script.js</span></span>
<span class="line"><span class="token comment">// 发送消息</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;USER_ACTION&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token string">&quot;button&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 可选的回调，处理响应</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;收到响应:&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Background 接收消息</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// background.js</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;收到来自 content script 的消息:&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;发送者信息:&quot;</span><span class="token punctuation">,</span> sender<span class="token punctuation">.</span>tab<span class="token operator">?.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;USER_ACTION&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 处理消息</span></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">processAction</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 发送响应</span></span>
<span class="line">      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 返回 true 表示异步响应</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> </span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-长连接通信-持续对话" tabindex="-1"><a class="header-anchor" href="#_2-长连接通信-持续对话"><span>2. 长连接通信（持续对话）</span></a></h4><p>建立连接</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// content-script.js</span></span>
<span class="line"><span class="token comment">// 建立连接</span></span>
<span class="line"><span class="token keyword">const</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;content-script-connection&quot;</span> </span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 监听来自 background 的消息</span></span>
<span class="line">port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;收到消息:&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>command <span class="token operator">===</span> <span class="token string">&quot;UPDATE_UI&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">updatePageUI</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 发送消息</span></span>
<span class="line">port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">  <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&quot;CONNECTION_READY&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">tabId</span><span class="token operator">:</span> chrome<span class="token punctuation">.</span>devtools<span class="token punctuation">.</span>inspectedWindow<span class="token punctuation">.</span>tabId </span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 断开连接时</span></span>
<span class="line">port<span class="token punctuation">.</span>onDisconnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;连接已断开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Background 处理连接</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// background.js</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">port</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;新的连接:&quot;</span><span class="token punctuation">,</span> port<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 只处理来自 content script 的连接</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;content-script-connection&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 监听消息</span></span>
<span class="line">    port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;来自 content script:&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 响应消息</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;CONNECTION_READY&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">          <span class="token literal-property property">command</span><span class="token operator">:</span> <span class="token string">&quot;SEND_DATA&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token string">&quot;default&quot;</span> <span class="token punctuation">}</span> </span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 主动发送消息</span></span>
<span class="line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">command</span><span class="token operator">:</span> <span class="token string">&quot;PING&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-与-popup-页面通信" tabindex="-1"><a class="header-anchor" href="#_3-与-popup-页面通信"><span>3. 与 Popup 页面通信</span></a></h4><p>Popup → Content Script（需要标签页ID）</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// popup.js</span></span>
<span class="line"><span class="token comment">// 获取当前标签页</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token punctuation">{</span> <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">currentWindow</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token parameter">tabs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 发送消息到该标签页的 content script</span></span>
<span class="line">      chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span></span>
<span class="line">        tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span> </span>
<span class="line">          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;FROM_POPUP&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">          <span class="token literal-property property">data</span><span class="token operator">:</span> popupData </span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Content script 响应:&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-存储共享通信" tabindex="-1"><a class="header-anchor" href="#_4-存储共享通信"><span>4. 存储共享通信</span></a></h4><p>通过 chrome.storage 共享数据</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// content-script.js - 存储数据</span></span>
<span class="line">chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token punctuation">{</span> <span class="token literal-property property">pageData</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">title</span><span class="token operator">:</span> document<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> location<span class="token punctuation">.</span>href <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;数据已保存&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// background.js - 读取数据</span></span>
<span class="line">chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;pageData&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;获取的数据:&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>pageData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="通信限制与注意事项" tabindex="-1"><a class="header-anchor" href="#通信限制与注意事项"><span>通信限制与注意事项</span></a></h4><ul><li>生命周期：Content script 随页面卸载而销毁</li><li>跨域限制：Content script 只能与自己的扩展通信</li><li>性能考虑：避免频繁发送大量数据</li><li>安全考虑：验证消息来源</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 验证发送者</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>id <span class="token operator">!==</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 忽略非本扩展的消息</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7、storage-api-local、sync、managed" tabindex="-1"><a class="header-anchor" href="#_7、storage-api-local、sync、managed"><span>7、Storage API（local、sync、managed）</span></a></h2><table><thead><tr><th style="text-align:center;">特性</th><th style="text-align:center;">chrome.storage.local</th><th style="text-align:center;">chrome.storage.sync</th><th style="text-align:center;">chrome.storage.managed</th></tr></thead><tbody><tr><td style="text-align:center;">数据位置</td><td style="text-align:center;">本地计算机</td><td style="text-align:center;">Chrome 账户同步</td><td style="text-align:center;">由管理员推送</td></tr><tr><td style="text-align:center;">存储上限</td><td style="text-align:center;">10 MB</td><td style="text-align:center;">100 KB 或 8 KB/项</td><td style="text-align:center;">无明确限制</td></tr><tr><td style="text-align:center;">同步范围</td><td style="text-align:center;">仅本机</td><td style="text-align:center;">跨设备（登录同一账户）</td><td style="text-align:center;">企业域内所有设备</td></tr><tr><td style="text-align:center;">适用场景</td><td style="text-align:center;">本地临时数据、大文件</td><td style="text-align:center;">用户设置、书签、偏好</td><td style="text-align:center;">企业策略、统一配置</td></tr><tr><td style="text-align:center;">权限要求</td><td style="text-align:center;">&quot;storage&quot;</td><td style="text-align:center;">&quot;storage&quot;</td><td style="text-align:center;">无特殊权限</td></tr></tbody></table><h2 id="_8、tabs-api" tabindex="-1"><a class="header-anchor" href="#_8、tabs-api"><span>8、Tabs API</span></a></h2><p>Tabs API 用于管理浏览器标签页，是扩展与网页交互的基础。</p><h3 id="查询、创建、更新" tabindex="-1"><a class="header-anchor" href="#查询、创建、更新"><span>查询、创建、更新</span></a></h3><h4 id="查询标签页" tabindex="-1"><a class="header-anchor" href="#查询标签页"><span>查询标签页</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 获取当前标签页</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">currentWindow</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">tabs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> currentTab <span class="token operator">=</span> tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 获取所有标签页</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">tabs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建标签页" tabindex="-1"><a class="header-anchor" href="#创建标签页"><span>创建标签页</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;https://example.com&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="更新标签页" tabindex="-1"><a class="header-anchor" href="#更新标签页"><span>更新标签页</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tabId<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="创建、更新、激活、关闭事件监听" tabindex="-1"><a class="header-anchor" href="#创建、更新、激活、关闭事件监听"><span>创建、更新、激活、关闭事件监听</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 标签页创建</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onCreated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">tab</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 标签页更新（URL/状态变化）</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onUpdated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tabId<span class="token punctuation">,</span> changeInfo<span class="token punctuation">,</span> tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>changeInfo<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;URL变化:&#39;</span><span class="token punctuation">,</span> changeInfo<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 标签页激活</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onActivated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">info</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 标签页关闭</span></span>
<span class="line">chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onRemoved<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">tabId</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="权限要求" tabindex="-1"><a class="header-anchor" href="#权限要求"><span>权限要求</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;tabs&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>核心使用场景 <ul><li>获取当前页面信息​ - 用于内容脚本注入</li><li>创建/管理标签页​ - 构建浏览器工具</li><li>监听页面变化​ - 实现自动化功能</li><li>跨标签页通信​ - 协调多页面操作</li></ul></li></ul><h2 id="_9、runtime-api" tabindex="-1"><a class="header-anchor" href="#_9、runtime-api"><span>9、Runtime API</span></a></h2><ul><li>Runtime API 是扩展的&quot;神经系统&quot;，负责： <ul><li>扩展生命周期管理</li><li>组件间通信</li><li>运行时信息获取</li></ul></li></ul><h3 id="四个关键用途" tabindex="-1"><a class="header-anchor" href="#四个关键用途"><span>四个关键用途</span></a></h3><h4 id="_1-消息通信" tabindex="-1"><a class="header-anchor" href="#_1-消息通信"><span>1. 消息通信</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 发送消息</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;action&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 接收消息</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">&#39;ok&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 异步响应时必需</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-获取运行时信息" tabindex="-1"><a class="header-anchor" href="#_2-获取运行时信息"><span>2. 获取运行时信息</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 扩展信息</span></span>
<span class="line"><span class="token keyword">const</span> manifest <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">getManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> id <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>id<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> url <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token string">&#39;page.html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-生命周期事件" tabindex="-1"><a class="header-anchor" href="#_3-生命周期事件"><span>3. 生命周期事件</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 扩展安装/更新</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">details</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>details<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">&#39;install&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 首次安装</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-打开页面" tabindex="-1"><a class="header-anchor" href="#_4-打开页面"><span>4. 打开页面</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 打开设置页</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">openOptionsPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 获取所有打开的页面</span></span>
<span class="line"><span class="token keyword">const</span> views <span class="token operator">=</span> chrome<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token function">getViews</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;popup&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10、permissions-api" tabindex="-1"><a class="header-anchor" href="#_10、permissions-api"><span>10、Permissions API</span></a></h2><p>Permissions API 用于动态管理扩展权限，让用户在需要时才授予权限，而非安装时强制要求。</p><h3 id="请求和检查权限" tabindex="-1"><a class="header-anchor" href="#请求和检查权限"><span>请求和检查权限</span></a></h3><h4 id="_1-请求权限" tabindex="-1"><a class="header-anchor" href="#_1-请求权限"><span>1. 请求权限</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 运行时请求权限</span></span>
<span class="line">chrome<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">permissions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;storage&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">origins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;https://api.example.com/*&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">granted</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>granted<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;权限已授予&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-检查权限" tabindex="-1"><a class="header-anchor" href="#_2-检查权限"><span>2. 检查权限</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 检查是否拥有权限</span></span>
<span class="line">chrome<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">permissions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;tabs&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;是否有tabs权限:&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11、declarative-content-api" tabindex="-1"><a class="header-anchor" href="#_11、declarative-content-api"><span>11、Declarative Content API</span></a></h2><p>Declarative Content API 允许扩展在特定页面自动激活，无需注入 content scripts。<br> 主要控制扩展图标何时在工具栏中可点击，并可以添加页面操作按钮。</p><h3 id="_1-设置规则" tabindex="-1"><a class="header-anchor" href="#_1-设置规则"><span>1. 设置规则</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 在background.js中</span></span>
<span class="line">chrome<span class="token punctuation">.</span>declarativeContent<span class="token punctuation">.</span>onPageChanged<span class="token punctuation">.</span><span class="token function">addRules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">conditions</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">chrome<span class="token punctuation">.</span>declarativeContent<span class="token punctuation">.</span>PageStateMatcher</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">pageUrl</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">hostEquals</span><span class="token operator">:</span> <span class="token string">&#39;example.com&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">chrome<span class="token punctuation">.</span>declarativeContent<span class="token punctuation">.</span>ShowPageAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// MV2</span></span>
<span class="line">    <span class="token comment">// 或</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">chrome<span class="token punctuation">.</span>declarativeContent<span class="token punctuation">.</span>ShowAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">// MV3</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-清除规则" tabindex="-1"><a class="header-anchor" href="#_2-清除规则"><span>2. 清除规则</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">chrome<span class="token punctuation">.</span>declarativeContent<span class="token punctuation">.</span>onPageChanged<span class="token punctuation">.</span><span class="token function">removeRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>使用场景 <ul><li>智能图标显示：只在相关网站显示扩展图标</li><li>减少注入：避免在所有页面注入content scripts</li><li>性能优化：非相关页面不激活扩展</li></ul></li></ul><h2 id="_12、通知-notifications" tabindex="-1"><a class="header-anchor" href="#_12、通知-notifications"><span>12、通知（Notifications）</span></a></h2><p>Notifications API 允许扩展显示系统级别的通知，即使用户不在浏览器中也能看到。</p><h3 id="_1-创建通知" tabindex="-1"><a class="header-anchor" href="#_1-创建通知"><span>1. 创建通知</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 简单通知</span></span>
<span class="line">chrome<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&#39;notification1&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;basic&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">iconUrl</span><span class="token operator">:</span> <span class="token string">&#39;icon.png&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;提醒&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;任务已完成&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">buttons</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;查看&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 带进度条</span></span>
<span class="line">chrome<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&#39;progress&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;progress&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;下载中&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;正在下载文件...&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token number">50</span>  <span class="token comment">// 0-100</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-通知类型" tabindex="-1"><a class="header-anchor" href="#_2-通知类型"><span>2. 通知类型</span></a></h3><ul><li>basic- 基本通知（图标+文字）</li><li>image- 带图片的通知</li><li>list- 列表通知（显示多个项目）</li><li>progress- 进度条通知</li></ul><h3 id="_3-事件处理" tabindex="-1"><a class="header-anchor" href="#_3-事件处理"><span>3. 事件处理</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 用户点击通知</span></span>
<span class="line">chrome<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">notificationId</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;通知被点击:&#39;</span><span class="token punctuation">,</span> notificationId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 用户点击按钮</span></span>
<span class="line">chrome<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span>onButtonClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">notificationId<span class="token punctuation">,</span> buttonIndex</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;按钮被点击:&#39;</span><span class="token punctuation">,</span> buttonIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重要特性 <ul><li>系统级通知：即使浏览器最小化也能显示</li><li>多种样式：支持图标、图片、列表、进度条</li><li>交互支持：可点击通知或按钮</li><li>自动消失：可设置优先级和超时时间</li></ul></li></ul><h2 id="_13、右键菜单-context-menus" tabindex="-1"><a class="header-anchor" href="#_13、右键菜单-context-menus"><span>13、右键菜单（Context Menus）</span></a></h2><p>Context Menus API 允许扩展在浏览器的右键菜单中添加自定义项目。</p><h3 id="_1-创建菜单" tabindex="-1"><a class="header-anchor" href="#_1-创建菜单"><span>1. 创建菜单</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 创建菜单项</span></span>
<span class="line">chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;my-menu&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;我的操作&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">contexts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;selection&#39;</span><span class="token punctuation">]</span>  <span class="token comment">// 选中文本时显示</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 子菜单</span></span>
<span class="line">chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;parent&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;父菜单&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">contexts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;all&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;child&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">parentId</span><span class="token operator">:</span> <span class="token string">&#39;parent&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;子菜单&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">contexts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;all&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-可用上下文" tabindex="-1"><a class="header-anchor" href="#_2-可用上下文"><span>2. 可用上下文</span></a></h3><ul><li>all- 所有情况</li><li>page- 页面空白处</li><li>selection- 选中文本</li><li>link- 链接</li><li>image- 图片</li><li>video/audio- 视频/音频</li><li>editable- 可编辑区域</li></ul><h3 id="_3-点击事件" tabindex="-1"><a class="header-anchor" href="#_3-点击事件"><span>3. 点击事件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">info<span class="token punctuation">,</span> tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>menuItemId <span class="token operator">===</span> <span class="token string">&#39;my-menu&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;选中的文本:&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>selectionText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>核心要点 <ul><li>background中创建：菜单必须在background script中创建</li><li>多种上下文：可针对不同场景显示不同菜单</li><li>图标支持：可添加图标到菜单项</li><li>动态更新：可创建后更新、删除菜单</li></ul></li></ul><h2 id="_14、错误监控与日志收集" tabindex="-1"><a class="header-anchor" href="#_14、错误监控与日志收集"><span>14、错误监控与日志收集</span></a></h2><h3 id="插件特定错误" tabindex="-1"><a class="header-anchor" href="#插件特定错误"><span>插件特定错误</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 监听扩展错误</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onError<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;扩展错误:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_15、plasmo框架详解" tabindex="-1"><a class="header-anchor" href="#_15、plasmo框架详解"><span>15、Plasmo框架详解</span></a></h2><p>目前比较受欢迎的开发框架和模板：</p><table><thead><tr><th style="text-align:center;">框架/模板名称</th><th style="text-align:center;">核心特点</th><th style="text-align:center;">适用场景</th></tr></thead><tbody><tr><td style="text-align:center;">Plasmo Framework</td><td style="text-align:center;">功能强大的浏览器扩展SDK，无需操心配置</td><td style="text-align:center;">希望获得开箱即用、现代化开发体验的项目</td></tr><tr><td style="text-align:center;">Chrome Extension (MV3) Boilerplate with React 18 + Webpack5</td><td style="text-align:center;">基于React 18和Webpack 5的现代化样板</td><td style="text-align:center;">熟悉React生态，需要模块化、热重载的开发</td></tr><tr><td style="text-align:center;">Create Chrome Extension (.crx)</td><td style="text-align:center;">基于Vite 4，支持多种前端框架，敏捷热更</td><td style="text-align:center;">追求极速构建，并希望灵活选择Vue、React、Svelte等框架</td></tr></tbody></table><h3 id="一、核心特性-1" tabindex="-1"><a class="header-anchor" href="#一、核心特性-1"><span>一、核心特性</span></a></h3><ul><li><ol><li>现代化开发体验</li></ol><ul><li>Plasmo内置了React和TypeScript的顶级支持，提供实时重载功能，修改代码后立即生效，React热模块替换技术保证了流畅的开发体验。</li></ul></li><li><ol start="2"><li>声明式开发模式</li></ol><ul><li>采用声明式开发，无需手动处理繁琐的配置文件。框架自动处理从代码编译到插件打包的完整流程，大幅提升开发效率。</li></ul></li><li><ol start="3"><li>跨浏览器兼容</li></ol><ul><li>同一份代码可以轻松部署到Chrome、Firefox、Edge等多个浏览器平台，解决了传统插件开发中最大的痛点之一。</li></ul></li><li><ol start="4"><li>强大生态系统</li></ol><ul><li>从消息传递到存储管理，从环境变量到远程代码集成，Plasmo提供了完整的功能模块。</li></ul></li></ul><h3 id="二、消息通信机制" tabindex="-1"><a class="header-anchor" href="#二、消息通信机制"><span>二、消息通信机制</span></a></h3><p>Plasmo提供了简洁高效的消息通信机制，核心在于<code>useMessage</code>和<code>usePort</code>两个React钩子：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 后台服务</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> relayMessage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@plasmohq/messaging&quot;</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;GET_USER_DATA&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&quot;Plasmo User&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 内容脚本</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> useMessage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@plasmohq/messaging/hook&quot;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">ContentScript</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useMessage</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Received message:&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&quot;received&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Message data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 弹出页面</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> usePort <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@plasmohq/messaging/hook&quot;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">Popup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> send<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">usePort</span><span class="token punctuation">(</span><span class="token string">&quot;popup-port&quot;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&quot;FETCH_DATA&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>获取数据<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>响应数据<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、状态管理" tabindex="-1"><a class="header-anchor" href="#三、状态管理"><span>三、状态管理</span></a></h3><p>Plasmo的持久化存储API简化了跨上下文（弹出页、内容脚本、后台）的状态共享：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// store.ts - 状态定义</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> persistentStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@plasmohq/persistent&quot;</span></span>
<span class="line"><span class="token keyword">interface</span> <span class="token class-name">UserState</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">theme</span><span class="token operator">:</span> <span class="token string">&quot;light&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;dark&quot;</span></span>
<span class="line">  <span class="token literal-property property">notifications</span><span class="token operator">:</span> boolean</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> userStore <span class="token operator">=</span> persistentStore<span class="token operator">&lt;</span>UserState<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">theme</span><span class="token operator">:</span> <span class="token string">&quot;light&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">notifications</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// popup.tsx - 修改状态</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> userStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./store&quot;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">ThemeToggle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">[</span>theme<span class="token punctuation">,</span> setTheme<span class="token punctuation">]</span> <span class="token operator">=</span> userStore<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&quot;theme&quot;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTheme</span><span class="token punctuation">(</span>theme <span class="token operator">===</span> <span class="token string">&quot;light&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;dark&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;light&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      Toggle <span class="token punctuation">{</span>theme<span class="token punctuation">}</span> theme</span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// content-script.tsx - 读取状态</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> userStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./store&quot;</span></span>
<span class="line">userStore<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>theme <span class="token operator">=</span> state<span class="token punctuation">.</span>theme</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_16、谷歌插件打包以及发布" tabindex="-1"><a class="header-anchor" href="#_16、谷歌插件打包以及发布"><span>16、谷歌插件打包以及发布</span></a></h2><h3 id="打包crx文件" tabindex="-1"><a class="header-anchor" href="#打包crx文件"><span>打包CRX文件</span></a></h3><h4 id="方案1" tabindex="-1"><a class="header-anchor" href="#方案1"><span>方案1：</span></a></h4><p><strong>通过浏览器扩展管理页面打包（推荐）</strong>：在Chrome浏览器地址栏输入 chrome://extensions/并回车，打开右上角的 “开发者模式”​ 开关，点击 “打包扩展程序”​ 按钮，选择你的插件根目录（包含manifest.json的文件夹），然后点击 “打包扩展程序”​ 即可。成功后会生成一个 <code>.crx</code>文件和一个 <code>.pem</code>私钥文件。请务必妥善保管 <code>.pem</code>私钥文件，它是该扩展程序的“身份证”，后续更新版本时必须使用同一私钥重新签名，否则无法正常更新。</p><h4 id="方案2" tabindex="-1"><a class="header-anchor" href="#方案2"><span>方案2：</span></a></h4><p><strong>通过命令行工具打包（适合自动化）</strong>：可以使用 Google 提供的脚本或 Node.js 工具（如 crx3）进行打包。基本命令格式如下</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code class="language-python"><span class="line"><span class="token comment"># 使用官方脚本示例</span></span>
<span class="line">python crx_make<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>extension<span class="token operator">-</span><span class="token builtin">dir</span><span class="token operator">=</span><span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>your<span class="token operator">/</span>extension <span class="token operator">-</span><span class="token operator">-</span>key<span class="token operator">-</span><span class="token builtin">file</span><span class="token operator">=</span><span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>your<span class="token operator">/</span>key<span class="token punctuation">.</span>pem <span class="token operator">-</span><span class="token operator">-</span>output<span class="token operator">-</span>crx<span class="token operator">=</span>output<span class="token punctuation">.</span>crx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="提高审核通过率的建议" tabindex="-1"><a class="header-anchor" href="#提高审核通过率的建议"><span>提高审核通过率的建议</span></a></h3><ul><li>权限申请遵循最小化原则：在 manifest.json中只申请插件运行所必需的权限。对于每个申请的权限，都要在提交页面的“权限”部分提供清晰、诚恳的理由，说明为何需要此权限以及如何保护用户数据。</li><li>避免使用过于宽泛的权限：尽量避免使用 <code>&lt;all_urls&gt;</code>这样的主机权限。如果插件并非需要在所有网站上运行，应将其替换为具体的域名列表，或使用 activeTab权限（仅在用户点击插件图标时临时获取当前标签页的权限）。</li><li>准备高质量的商品详情页：这是说服用户安装的重要环节。需要准备至少一张尺寸为 1280x800 或 640x400​ 像素的清晰宣传截图或宣传视频。插件的文字描述（包括名称、简短描述和详细说明）应准确、易懂，突出核心功能和价值。如果插件会处理用户数据，必须提供一份可公开访问的隐私政策</li></ul><h3 id="插件版本更新" tabindex="-1"><a class="header-anchor" href="#插件版本更新"><span>插件版本更新</span></a></h3><h4 id="_1-后台自动更新" tabindex="-1"><a class="header-anchor" href="#_1-后台自动更新"><span>1. 后台自动更新</span></a></h4><p>Chrome浏览器会定期检查插件更新</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// background.js - 监听更新事件</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onUpdateAvailable<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">details</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;发现新版本:&#39;</span><span class="token punctuation">,</span> details<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 立即应用更新</span></span>
<span class="line">  chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 监听更新安装完成</span></span>
<span class="line">chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">details</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>details<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;插件已更新至版本:&#39;</span><span class="token punctuation">,</span> details<span class="token punctuation">.</span>previousVersion<span class="token punctuation">,</span> <span class="token string">&#39;→&#39;</span><span class="token punctuation">,</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">getManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-手动检查更新" tabindex="-1"><a class="header-anchor" href="#_2-手动检查更新"><span>2. 手动检查更新</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 在popup或options页面中</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">checkForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">requestUpdateCheck</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">status<span class="token punctuation">,</span> details</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token string">&#39;update_available&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;发现更新:&#39;</span><span class="token punctuation">,</span> details<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 提示用户重启浏览器或重新加载插件</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token string">&#39;no_update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;当前已是最新版本&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token string">&#39;throttled&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;更新检查过于频繁，请稍后再试&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,204)])])}const u=s(c,[["render",l]]),r=JSON.parse('{"path":"/pages/assit/chrome/Develop.html","title":"","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1768022246000,"contributors":[{"name":"nxiang","username":"","email":"837435186@qq.com","commits":1}],"changelog":[{"hash":"95e42b84ce2b2a60354f31de54bd20151bb23c66","time":1768022246000,"email":"837435186@qq.com","author":"nxiang","message":"update"}]},"filePathRelative":"pages/assit/chrome/Develop.md"}');export{u as comp,r as data};
